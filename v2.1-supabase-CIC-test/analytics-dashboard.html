<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="64x64" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <title>NAEI Viewer Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h3 { margin-top: 0; color: #333; border-bottom: 2px solid #007cba; padding-bottom: 10px; }
        .metric { font-size: 24px; font-weight: bold; color: #007cba; }
        .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .table th, .table td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: 600; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background: #fee; color: #c33; padding: 15px; border-radius: 4px; margin: 10px 0; }
        .refresh-btn { background: #007cba; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .date-range { margin-bottom: 20px; }
        .date-range input { margin: 0 5px; padding: 5px; }
    </style>
</head>
<body>
    <h1>üìä NAEI Multi-Group Viewer - Analytics Dashboard</h1>
    
    <div class="date-range">
        <label>Date Range:</label>
        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button class="refresh-btn" onclick="loadAnalytics()">üîÑ Refresh</button>
        <span style="margin-left: 20px; color: #666;">Last updated: <span id="lastUpdated">Never</span></span>
    </div>

    <div id="loading" class="loading">üîÑ Loading analytics data...</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="dashboard" class="dashboard" style="display: none;"></div>

    <script>
        // Supabase connection (same as your main app)
        const SUPABASE_URL = 'https://vhplzwzzkeueyelaqftl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZocGx6d3p6a2V1ZXllbGFxZnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjQwODUsImV4cCI6MjA3NjA0MDA4NX0.mBAwFmfSpqffvp1GGDHKvp-y_hukSZmF4GN-Ghnf--o';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Set default date range (last 30 days)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);
        
        document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];

        async function loadAnalytics() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const dashboard = document.getElementById('dashboard');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            dashboard.style.display = 'none';

            try {
                const startDate = document.getElementById('startDate').value + 'T00:00:00Z';
                const endDate = document.getElementById('endDate').value + 'T23:59:59Z';

                // Get basic metrics
                const { data: events, error: eventsError } = await supabase
                    .from('analytics_events')
                    .select('*')
                    .gte('timestamp', startDate)
                    .lte('timestamp', endDate);

                if (eventsError) throw eventsError;

                // Get popular pollutants, groups, exports
                const [pollutantsResp, groupsResp, exportsResp] = await Promise.all([
                    supabase.from('popular_pollutants').select('*').limit(10),
                    supabase.from('popular_groups').select('*').limit(10),
                    supabase.from('export_stats').select('*').limit(20)
                ]);

                const pollutants = pollutantsResp.data || [];
                const groups = groupsResp.data || [];
                const exports = exportsResp.data || [];

                // Calculate basic metrics
                const totalEvents = events.length;
                const uniqueSessions = new Set(events.map(e => e.session_id)).size;
                const uniqueUsers = new Set(events.map(e => e.user_fingerprint)).size;
                
                // Calculate engagement metrics
                const eventTypes = {};
                const countries = {};
                const uiInteractions = {
                    how_to_use: 0,
                    group_info: 0,
                    smoothing_toggle: 0
                };

                events.forEach(e => {
                    eventTypes[e.event_type] = (eventTypes[e.event_type] || 0) + 1;
                    
                    // Country tracking
                    const country = e.event_data?.country;
                    if (country && country !== 'Unknown') {
                        countries[country] = (countries[country] || 0) + 1;
                    }
                    
                    // UI interaction tracking
                    if (e.event_type === 'ui_interaction') {
                        const element = e.event_data?.element;
                        if (element === 'how_to_use_section') uiInteractions.how_to_use++;
                        if (element === 'group_info_section') uiInteractions.group_info++;
                        if (element === 'smoothing_toggle') uiInteractions.smoothing_toggle++;
                    }
                });

                // Session engagement analysis
                const sessionLengths = {};
                const sessionEvents = {};
                events.forEach(e => {
                    const sid = e.session_id;
                    if (!sessionEvents[sid]) sessionEvents[sid] = [];
                    sessionEvents[sid].push(new Date(e.timestamp));
                });

                Object.entries(sessionEvents).forEach(([sid, timestamps]) => {
                    if (timestamps.length > 1) {
                        // Sort numerically
                        const sorted = timestamps.sort((a, b) => a - b);
                        const duration = (sorted[sorted.length - 1] - sorted[0]) / (1000 * 60); // minutes
                        if (duration >= 0) {
                            sessionLengths[sid] = Math.round(duration);
                        }
                    }
                });

                // Only use non-negative durations for average
                const validDurations = Object.values(sessionLengths).filter(d => d >= 0);
                const avgSessionLength = validDurations.length > 0 
                    ? Math.round(validDurations.reduce((a, b) => a + b, 0) / validDurations.length)
                    : 0;

                // Daily breakdown calculation
                const dailyStats = {};
                events.forEach(e => {
                    const day = e.timestamp.slice(0, 10); // YYYY-MM-DD
                    if (!dailyStats[day]) {
                        dailyStats[day] = {
                            events: 0,
                            sessions: new Set(),
                            users: new Set()
                        };
                    }
                    dailyStats[day].events++;
                    dailyStats[day].sessions.add(e.session_id);
                    dailyStats[day].users.add(e.user_fingerprint);
                });

                // Render dashboard
                dashboard.innerHTML = `
                    <div class="card">
                        <h3>üìà Overview</h3>
                        <p>Total Events: <span class="metric">${totalEvents}</span></p>
                        <p>Unique Sessions: <span class="metric">${uniqueSessions}</span></p>
                        <p>Unique Users: <span class="metric">${uniqueUsers}</span></p>
                        <p>Avg Session Length: <span class="metric">${avgSessionLength} min</span></p>
                    </div>

                    <div class="card">
                        <h3>üìÖ Daily Breakdown</h3>
                        <table class="table">
                            <tr><th>Date</th><th>Total Events</th><th>Unique Sessions</th><th>Unique Users</th></tr>
                            ${Object.entries(dailyStats).sort(([a], [b]) => b.localeCompare(a)).map(([date, stats]) =>
                                `<tr><td>${date}</td><td>${stats.events}</td><td>${stats.sessions.size}</td><td>${stats.users.size}</td></tr>`
                            ).join('') || '<tr><td colspan="4">No data available</td></tr>'}
                        </table>
                    </div>

                    <div class="card">
                        <h3>üåç Countries</h3>
                        <table class="table">
                            <tr><th>Country</th><th>Sessions</th></tr>
                            ${Object.entries(countries).sort(([,a], [,b]) => b - a).slice(0, 10).map(([country, count]) => 
                                `<tr><td>${country}</td><td>${count}</td></tr>`
                            ).join('') || '<tr><td colspan="2">No country data</td></tr>'}
                        </table>
                    </div>

                    <div class="card">
                        <h3>üéØ Event Types</h3>
                        <table class="table">
                            <tr><th>Event</th><th>Count</th></tr>
                            ${Object.entries(eventTypes).sort(([,a], [,b]) => b - a).map(([type, count]) => 
                                `<tr><td>${type.replace(/_/g, ' ')}</td><td>${count}</td></tr>`
                            ).join('')}
                        </table>
                    </div>

                    <div class="card">
                        <h3>üñ±Ô∏è UI Interactions</h3>
                        <p>"How to Use" opens: <span class="metric">${uiInteractions.how_to_use}</span></p>
                        <p>"Group Info" opens: <span class="metric">${uiInteractions.group_info}</span></p>
                        <p>Smoothing toggles: <span class="metric">${uiInteractions.smoothing_toggle}</span></p>
                        <p><strong>Total UI interactions:</strong> <span class="metric">${eventTypes.ui_interaction || 0}</span></p>
                    </div>

                    <div class="card">
                        <h3>üß™ Popular Pollutants</h3>
                        <table class="table">
                            <tr><th>Pollutant</th><th>Views</th><th>Sessions</th><th>Avg Years</th></tr>
                            ${(pollutants || []).map(p => 
                                `<tr><td>${p.pollutant}</td><td>${p.views}</td><td>${p.unique_sessions}</td><td>${p.avg_year_range ? Math.round(p.avg_year_range) : '-'}</td></tr>`
                            ).join('') || '<tr><td colspan="4">No data available</td></tr>'}
                        </table>
                    </div>

                    <div class="card">
                        <h3>üë• Popular Groups</h3>
                        <table class="table">
                            <tr><th>Group</th><th>Usage</th><th>Sessions</th></tr>
                            ${(groups || []).map(g => 
                                `<tr><td>${g.group_name}</td><td>${g.usage_count}</td><td>${g.unique_sessions}</td></tr>`
                            ).join('') || '<tr><td colspan="3">No data available</td></tr>'}
                        </table>
                    </div>

                    <div class="card">
                        <h3>‚¨áÔ∏è Download Statistics</h3>
                        <table class="table">
                            <tr><th>Format</th><th>Pollutant</th><th>Downloads</th><th>Users</th></tr>
                            ${(exports || []).map(e => 
                                `<tr><td>${e.export_format}</td><td>${e.pollutant}</td><td>${e.download_count}</td><td>${e.unique_downloaders}</td></tr>`
                            ).join('') || '<tr><td colspan="4">No data available</td></tr>'}
                        </table>
                    </div>

                    <div class="card">
                        <h3>üìä Session Engagement</h3>
                        <p>Sessions with multiple events: <span class="metric">${Object.keys(sessionLengths).length}</span></p>
                        <p>Single-event sessions: <span class="metric">${uniqueSessions - Object.keys(sessionLengths).length}</span></p>
                        <p>Bounce rate: <span class="metric">${uniqueSessions > 0 ? Math.round(((uniqueSessions - Object.keys(sessionLengths).length) / uniqueSessions) * 100) : 0}%</span></p>
                        <p>Return rate: <span class="metric">${Math.round((uniqueUsers > 0 ? (uniqueSessions - uniqueUsers) / uniqueUsers : 0) * 100)}%</span></p>
                    </div>

                    <div class="card">
                        <h3>üìä Recent Activity</h3>
                        <table class="table">
                            <tr><th>Time</th><th>Event</th><th>Details</th></tr>
                            ${events.slice(-10).reverse().map(e => 
                                `<tr>
                                    <td>${new Date(e.timestamp).toLocaleString()}</td>
                                    <td>${e.event_type.replace(/_/g, ' ')}</td>
                                    <td>${e.event_data?.pollutant || e.event_data?.element || JSON.stringify(e.event_data).substr(0,30)}</td>
                                </tr>`
                            ).join('')}
                        </table>
                    </div>
                `;

                loading.style.display = 'none';
                dashboard.style.display = 'grid';
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

            } catch (err) {
                console.error('Analytics error:', err);
                error.textContent = 'Failed to load analytics: ' + err.message;
                error.style.display = 'block';
                loading.style.display = 'none';
            }
        }

        // Load analytics on page load
        document.addEventListener('DOMContentLoaded', loadAnalytics);
        
        // Auto-refresh every 30 seconds
        setInterval(loadAnalytics, 300000);
    </script>
</body>
</html>