<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>v2.3 Module Test</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .pass { color: green; }
    .fail { color: red; }
    .pending { color: orange; }
    h2 { margin-top: 0; }
    code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <h1>v2.3 Modular Architecture Test</h1>
  
  <div class="test-section">
    <h2>Script Loading</h2>
    <div id="script-loading">Testing...</div>
  </div>

  <div class="test-section">
    <h2>Function Availability</h2>
    <div id="function-tests">Testing...</div>
  </div>

  <div class="test-section">
    <h2>Variable Accessibility</h2>
    <div id="variable-tests">Testing...</div>
  </div>

  <div class="test-section">
    <h2>Initialization Simulation</h2>
    <div id="init-test">Testing...</div>
  </div>

  <!-- Load the modules in order -->
  <script src="supabase.js"></script>
  <script src="main.js"></script>
  <script src="export.js"></script>

  <!-- Run tests -->
  <script>
    function runTests() {
      const results = {
        scripts: true,
        functions: [],
        variables: [],
        init: false
      };

      // Test 1: Script Loading
      const scriptLoadDiv = document.getElementById('script-loading');
      scriptLoadDiv.innerHTML = '<span class="pass">✓ All scripts loaded successfully</span>';

      // Test 2: Function Availability
      const functionsToTest = {
        'supabase.js': ['loadUnits', 'loadData', 'loadGroupInfo', 'trackAnalytics'],
        'main.js': ['renderInitialView', 'revealMainContent', 'updateChart', 'init'],
        'export.js': ['exportData', 'generateShareUrl', 'getCleanChartImageURI']
      };

      let functionHtml = '<ul>';
      for (const [module, funcs] of Object.entries(functionsToTest)) {
        functionHtml += `<li><strong>${module}</strong><ul>`;
        for (const func of funcs) {
          // Check if function exists in global scope
          const exists = typeof window[func] === 'function';
          if (exists) {
            functionHtml += `<li class="pass">✓ ${func}</li>`;
            results.functions.push({ func, exists: true });
          } else {
            functionHtml += `<li class="fail">✗ ${func} - not found in global scope</li>`;
            results.functions.push({ func, exists: false, error: 'not found' });
          }
        }
        functionHtml += '</ul></li>';
      }
      functionHtml += '</ul>';
      document.getElementById('function-tests').innerHTML = functionHtml;

      // Test 3: Variable Accessibility
      const variablesToTest = [
        'pollutantUnits',
        'groupedData',
        'pollutantsData',
        'groupsData',
        'smoothLines'
      ];

      let variableHtml = '<ul>';
      for (const varName of variablesToTest) {
        // Check if variable exists in global scope
        if (typeof window[varName] !== 'undefined') {
          const value = window[varName];
          const type = typeof value;
          variableHtml += `<li class="pass">✓ ${varName} (${type})</li>`;
          results.variables.push({ varName, accessible: true, type });
        } else {
          variableHtml += `<li class="fail">✗ ${varName} - not accessible in global scope</li>`;
          results.variables.push({ varName, accessible: false, error: 'not found' });
        }
      }
      
      // Test window.smoothLines
      if (typeof window.smoothLines !== 'undefined') {
        variableHtml += `<li class="pass">✓ window.smoothLines (${typeof window.smoothLines})</li>`;
      } else {
        variableHtml += `<li class="fail">✗ window.smoothLines not defined</li>`;
      }
      
      variableHtml += '</ul>';
      document.getElementById('variable-tests').innerHTML = variableHtml;

      // Test 4: Initialization Check
      const initDiv = document.getElementById('init-test');
      try {
        // Check if init function exists in global scope
        if (typeof window.init === 'function') {
          initDiv.innerHTML = '<span class="pass">✓ init() function exists and is properly defined</span><br>';
          initDiv.innerHTML += '<span class="pending">⚠ Full initialization requires Google Charts and Supabase connection</span><br>';
          initDiv.innerHTML += '<span class="pending">⚠ Manual testing in browser required to verify complete initialization</span>';
          results.init = true;
        } else {
          initDiv.innerHTML = '<span class="fail">✗ init() function not found</span>';
        }
      } catch (e) {
        initDiv.innerHTML = `<span class="fail">✗ Error checking init: ${e.message}</span>`;
      }

      // Summary
      const allFunctionsExist = results.functions.every(f => f.exists);
      const allVariablesAccessible = results.variables.every(v => v.accessible);
      
      console.log('Test Results:', results);
      
      if (results.scripts && allFunctionsExist && allVariablesAccessible && results.init) {
        console.log('%c✅ All tests passed!', 'color: green; font-weight: bold; font-size: 16px;');
      } else {
        console.log('%c⚠ Some tests failed - see details above', 'color: orange; font-weight: bold; font-size: 16px;');
      }
    }

    // Run tests when page loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runTests);
    } else {
      runTests();
    }
  </script>
</body>
</html>
