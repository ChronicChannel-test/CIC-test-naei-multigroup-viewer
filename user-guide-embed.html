<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NAEI User Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Embedded user guide for the UK Air Pollution and Emissions Explorer">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&family=Inter:wght@400;500;600;700&family=Roboto:wght@400;600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="SharedResources/common-styles.css">
  <style>
    :root {
      --user-guide-buffer: 27px;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #ffffff;
      color: #0f172a;
      margin: 0;
    }

    .user-guide-shell {
      padding-bottom: 8px;
      margin: 0;
    }

    .user-guide-downloads {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 0 0 20px 0;
      padding-left: 0;
    }

    .user-guide-download {
      color: #ff8c1a;
      font-weight: 600;
      text-decoration: none;
      font-size: 1rem;
      display: inline-flex;
    }

    .user-guide-download:hover,
    .user-guide-download:focus-visible {
      color: #cc6c00;
    }

    .user-guide-title {
      font-weight: 700 !important;
      letter-spacing: 0;
    }

    .chart-wrapper.user-guide-wrapper {
      min-height: 460px;
    }

    .user-guide-wrapper iframe {
      width: 100%;
      height: 100%;
      border: 0;
      background: #fff;
      display: block;
    }

    .sidebar-socials {
      display: none !important;
    }

    @media (max-width: 900px) {
      .chart-wrapper.user-guide-wrapper {
        width: 100%;
      }
    }

    @media (max-width: 640px) {
      .chart-shell {
        padding: 18px 18px 30px;
      }

      .main-title {
        font-size: 26px;
      }
    }
  </style>
</head>
<body>
  <div class="chart-shell user-guide-shell">
    <div id="mainContent">
      <div class="title-row">
        <h2 class="main-title user-guide-title" style="font-weight: 700;">
          <span class="title-part title-part-1">User</span>
          <span class="title-part title-part-2">Guide</span>
        </h2>
      </div>

      <div class="user-guide-downloads" role="group" aria-label="User guide downloads">
        <a id="downloadUserGuide" class="user-guide-download" href="SharedResources/docs/User-Guide-Pollution-Emissions-Data-Explorer-v0.6.pdf" download target="_blank" rel="noopener">Download User Guide PDF</a>
        <a id="downloadTutorial" class="user-guide-download" href="SharedResources/docs/Bubble-Chart-Tutorial-v3.pdf" download target="_blank" rel="noopener">Download Bubble Chart Tutorial</a>
      </div>

      <div class="chart-wrapper user-guide-wrapper" role="region" aria-label="User guide PDF viewer">
        <iframe id="userGuidePdfFrame" title="User Guide PDF via PDF.js" loading="lazy"></iframe>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const basePdfPath = 'SharedResources/docs/User-Guide-Pollution-Emissions-Data-Explorer-v0.6.pdf';
      const tutorialPdfPath = 'SharedResources/docs/Bubble-Chart-Tutorial-v3.pdf';
      const pdfjsViewerPath = 'SharedResources/pdfjs/viewer.html';
      const frame = document.getElementById('userGuidePdfFrame');
      const wrapper = document.querySelector('.user-guide-wrapper');
      const shell = document.querySelector('.chart-shell');
      const downloadGuideLink = document.getElementById('downloadUserGuide');
      const downloadTutorialLink = document.getElementById('downloadTutorial');
      const WRAPPER_BUFFER = 27;
      const MIN_FRAME_HEIGHT = 460;
      let parentViewportHeight = null;
      let parentFooterHeight = 0;

      function getElementBottom(el) {
        if (!el) {
          return 0;
        }
        const rect = el.getBoundingClientRect();
        const scrollOffset = window.scrollY || window.pageYOffset || 0;
        return Math.max(0, Math.round((rect.bottom || 0) + scrollOffset));
      }

      function buildAbsoluteUrl(relativePath) {
        try {
          return new URL(relativePath, window.location.href).href;
        } catch (error) {
          console.warn('Unable to build absolute URL for user guide resource', error);
          return relativePath;
        }
      }

      function hydrateDownloadLinks() {
        if (downloadGuideLink) {
          downloadGuideLink.href = buildAbsoluteUrl(basePdfPath);
        }
        if (downloadTutorialLink) {
          downloadTutorialLink.href = buildAbsoluteUrl(tutorialPdfPath);
        }
      }

      function buildViewerUrl() {
        const absolutePdfUrl = buildAbsoluteUrl(basePdfPath);
        try {
          const viewerUrl = new URL(pdfjsViewerPath, window.location.href);
          viewerUrl.searchParams.set('disablePreferences', 'true');
          viewerUrl.searchParams.set('file', absolutePdfUrl);
          viewerUrl.hash = 'page=1&zoom=page-fit&spread=odd&view=spread';
          return viewerUrl.href;
        } catch (error) {
          console.warn('Unable to construct viewer URL, falling back to relative path', error);
          return `${pdfjsViewerPath}?disablePreferences=true&file=${encodeURIComponent(absolutePdfUrl)}#page=1&zoom=page-fit&spread=odd&view=spread`;
        }
      }

      function applyViewerSource() {
        const viewerUrl = buildViewerUrl();
        if (frame && frame.src !== viewerUrl) {
          frame.src = viewerUrl;
        }
      }

      function computeWrapperHeight() {
        const viewport = parentViewportHeight || window.innerHeight || (MIN_FRAME_HEIGHT + WRAPPER_BUFFER + parentFooterHeight);
        const footer = parentFooterHeight || 0;
        const available = viewport - footer - WRAPPER_BUFFER;
        return Math.max(available, MIN_FRAME_HEIGHT);
      }

      function applyWrapperHeight() {
        if (!wrapper || !frame) {
          return MIN_FRAME_HEIGHT;
        }
        const height = computeWrapperHeight();
        wrapper.style.height = `${height}px`;
        frame.style.height = `${height}px`;
        frame.style.minHeight = `${height}px`;
        return height;
      }

      function measureContentHeight() {
        const body = document.body;
        const html = document.documentElement;
        const documentHeight = Math.max(
          body?.scrollHeight || 0,
          body?.offsetHeight || 0,
          html?.scrollHeight || 0,
          html?.offsetHeight || 0
        );

        const shellBottom = getElementBottom(shell);
        const mainBottom = getElementBottom(document.getElementById('mainContent'));
        const wrapperBottom = getElementBottom(wrapper);
        const candidates = [shellBottom, mainBottom, wrapperBottom, documentHeight].filter(value => Number.isFinite(value) && value > 0);

        if (!candidates.length) {
          return Math.max(MIN_FRAME_HEIGHT + WRAPPER_BUFFER, 600);
        }

        return Math.max(...candidates);
      }

      function sendHeightToParent() {
        try {
          applyWrapperHeight();
          const height = measureContentHeight();
          window.parent.postMessage({
            type: 'contentHeight',
            chart: 'user-guide',
            height
          }, '*');
        } catch (error) {
          console.warn('Unable to post user-guide height', error);
        }
      }

      function scheduleHeightUpdate(delay = 60) {
        window.setTimeout(() => window.requestAnimationFrame(sendHeightToParent), delay);
      }

      function updateViewportMetrics(payload) {
        if (payload && Number.isFinite(payload.viewportHeight)) {
          parentViewportHeight = payload.viewportHeight;
        }
        if (payload && Number.isFinite(payload.footerHeight)) {
          parentFooterHeight = payload.footerHeight;
        }
        applyWrapperHeight();
        scheduleHeightUpdate(30);
      }

      function requestParentMetrics() {
        try {
          window.parent.postMessage({
            type: 'requestParentViewportMetrics',
            chart: 'user-guide'
          }, '*');
        } catch (error) {
          console.warn('Unable to request parent viewport metrics', error);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        hydrateDownloadLinks();
        applyViewerSource();
        applyWrapperHeight();
        scheduleHeightUpdate(120);
        requestParentMetrics();
      });

      if (frame) {
        frame.addEventListener('load', () => {
          applyWrapperHeight();
          scheduleHeightUpdate(120);
        });
      }

      window.addEventListener('message', event => {
        const payload = event?.data;
        if (!payload) {
          return;
        }

        if (payload.type === 'requestHeight') {
          scheduleHeightUpdate(40);
          return;
        }

        if (payload.type === 'parentViewportMetrics') {
          updateViewportMetrics(payload);
          return;
        }

        if (payload.type === 'parentFooterHeight' && Number.isFinite(payload.value)) {
          parentFooterHeight = payload.value;
          applyWrapperHeight();
          scheduleHeightUpdate(40);
        }
      });

      window.addEventListener('resize', () => {
        if (!parentViewportHeight) {
          scheduleHeightUpdate(90);
        }
      });
    })();
  </script>
</body>
</html>
