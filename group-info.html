<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NAEI Group Information</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="dist/tailwind.css">
  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #ffffff;
      color: #1f2937;
      margin: 0;
      padding: 0;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    #groupTable {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.95rem;
      color: #0f172a;
      font-family: inherit;
    }

    #groupTable th,
    #groupTable td {
      border: 1px solid #444;
      padding: 12px;
      text-align: left;
      vertical-align: top;
      white-space: pre-line;
    }

    #groupTable thead tr {
      background: #d0d0d0;
    }

    #groupTable tbody tr {
      cursor: pointer;
    }

    #groupTable tbody tr:hover {
      background: #f5f5f5;
    }

    #groupTable th:nth-child(1),
    #groupTable td:nth-child(1) {
      width: 26%;
    }

    #groupTable th:nth-child(2),
    #groupTable td:nth-child(2) {
      width: 6.5%;
      white-space: nowrap;
    }

    #groupTable th:nth-child(3),
    #groupTable td:nth-child(3) {
      width: 39.5%;
    }

    #groupTable th:nth-child(4),
    #groupTable td:nth-child(4) {
      width: 28%;
    }

    .group-info-source-heading {
      text-decoration: underline;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    .group-info-source-heading mark.group-info-highlight {
      text-decoration: inherit;
    }

    .group-info-item-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 4px;
    }

    .group-info-item {
      display: block;
      line-height: 1.25;
    }

    mark.group-info-highlight {
      background: rgba(255, 174, 1, 0.45);
      color: #5b2109;
      padding: 0;
      border-radius: 2px;
      box-decoration-break: clone;
      -webkit-box-decoration-break: clone;
    }

    .group-info-activity-column {
      text-align: left !important;
      vertical-align: middle;
    }

    .group-info-activity-heading {
      display: inline-block;
      text-align: left;
      line-height: 1.1;
    }

    .group-info-activity-cell {
      text-align: left;
      vertical-align: top;
      white-space: nowrap;
      padding-right: 12px;
      line-height: 1;
      position: relative;
      min-height: 24px;
    }

    .group-info-activity-icon {
      width: 24px;
      height: 24px;
      position: absolute;
      top: 12px;
      left: 12px;
    }

    @media (min-width: 980px) {
      .group-info-item-list--multi {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .group-info-shell {
      padding: 20px;
    }

    .group-info-frame {
      width: calc(100% - 140px);
      margin: 0 auto 0 0;
      border-radius: 6px;
      background: #ffffff;
      box-sizing: border-box;
      padding: 0 32px 32px 0;
      overflow: hidden;
      box-shadow: none;
      border: none;
    }

    .group-info-header {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
      gap: 10px;
      margin-bottom: 6px;
    }

    .group-info-title-main {
      font-size: 28px;
      font-weight: 700;
      line-height: 1.1;
      color: #0f172a;
    }

    .group-info-filter-block {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin: 28px 0 16px;
      max-width: 100%;
    }

    .group-info-filter-label {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1f2937;
      white-space: nowrap;
    }

    .group-info-filter-input {
      flex: 1 1 320px;
      min-width: 240px;
      padding: 10px 14px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
      color: #0f172a;
      background-color: #fff;
    }

    .group-info-filter-input:disabled {
      cursor: not-allowed;
      background-color: #f1f5f9;
      color: #94a3b8;
      border-color: #d1d5db;
    }

    .group-info-filter-input:focus {
      outline: 2px solid #ff9301;
      outline-offset: 1px;
    }

    .group-info-column-filters {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .group-info-column-label {
      font-size: 0.95rem;
      font-weight: 600;
      color: #1f2937;
      white-space: nowrap;
    }

    .group-info-column-options {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }

    .group-info-column-option {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.95rem;
      color: #1f2937;
    }

    .group-info-table-container {
      margin-top: 18px;
      overflow-x: auto;
    }

    .status-text {
      font-size: 0.75rem;
      color: #6b7280;
      min-height: 1.25rem;
      margin-bottom: 16px;
    }

    #group-info-status:empty {
      min-height: 0;
      height: 0;
      margin-bottom: 0;
    }

    @media (max-width: 1100px) {
      .group-info-frame {
        width: 100%;
        padding: 0 24px 32px 0;
      }

      .group-info-shell {
        padding: 20px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="SharedResources/supabase-config.js"></script>
  <script src="SharedResources/shared-data-loader.js"></script>
</head>
<body>
  <main class="group-info-shell">
    <section class="group-info-frame" aria-labelledby="group-info-heading">
      <header class="group-info-header">
        <div class="group-info-title-main" id="group-info-heading">Group Information</div>
      </header>

      <div class="group-info-filter-block">
        <label for="group-info-filter-input" class="group-info-filter-label">Filter:</label>
        <input type="search" id="group-info-filter-input" class="group-info-filter-input" placeholder="Search groups, sources, or fuel types" autocomplete="off" aria-describedby="group-info-filter-columns-label">
      </div>

      <div class="group-info-column-filters" role="group" aria-labelledby="group-info-filter-columns-label">
        <span class="group-info-column-label" id="group-info-filter-columns-label">Filter Columns:</span>
        <div class="group-info-column-options">
          <label class="group-info-column-option">
            <input type="checkbox" id="group-info-filter-column-all" value="all" checked>
            <span>All</span>
          </label>
          <label class="group-info-column-option">
            <input type="checkbox" id="group-info-filter-column-name" value="name" checked>
            <span>Group Name</span>
          </label>
          <label class="group-info-column-option">
            <input type="checkbox" id="group-info-filter-column-sources" value="sources" checked>
            <span>Sources &amp; NFR Code</span>
          </label>
          <label class="group-info-column-option">
            <input type="checkbox" id="group-info-filter-column-fuels" value="fuels" checked>
            <span>Fuel Types</span>
          </label>
        </div>
      </div>

      <p id="group-info-status" class="status-text" aria-live="polite"></p>

      <div class="group-info-table-container">
        <div id="group-info-content">
          Loading group information…
        </div>
      </div>
    </section>
  </main>

  <script>
    (function() {
      const statusEl = document.getElementById('group-info-status');
      const contentEl = document.getElementById('group-info-content');
      const filterInput = document.getElementById('group-info-filter-input');
      const columnOptionsEl = document.querySelector('.group-info-column-options');
      const columnCheckboxes = columnOptionsEl ? Array.from(columnOptionsEl.querySelectorAll('input[type="checkbox"]')) : [];
      let statusTimer = null;
      let groupInfoState = null;
      const highlightMatchesEnabled = true;
      let filterInputActive = true;

      function setFilterInputState(isActive) {
        if (!filterInput) {
          return;
        }

        filterInputActive = Boolean(isActive);
        filterInput.disabled = !filterInputActive;
        filterInput.setAttribute('aria-disabled', filterInputActive ? 'false' : 'true');
        if (!filterInputActive) {
          filterInput.blur();
        }
      }

      function isFilterInputActive() {
        return filterInputActive;
      }

      function setStatus(message, persist = false) {
        if (!statusEl) return;
        statusEl.textContent = message || '';
        if (!persist) {
          clearTimeout(statusTimer);
          statusTimer = setTimeout(() => {
            statusEl.textContent = '';
          }, 4000);
        }
      }

      function measureHeight() {
        const body = document.body;
        const docEl = document.documentElement;
        let height = Math.max(
          body ? body.scrollHeight : 0,
          body ? body.offsetHeight : 0,
          docEl ? docEl.scrollHeight : 0,
          docEl ? docEl.offsetHeight : 0,
          600
        );
        if (!Number.isFinite(height) || height <= 0) {
          height = 800;
        }
        return height;
      }

      function sendHeightToParent() {
        try {
          const height = measureHeight();
          window.parent.postMessage({
            type: 'contentHeight',
            chart: 'group-info',
            height
          }, '*');
        } catch (error) {
          console.warn('Unable to send group info height to parent:', error);
        }
      }

      function scheduleHeightUpdate(delay = 50) {
        setTimeout(() => {
          requestAnimationFrame(sendHeightToParent);
        }, delay);
      }

      async function ensureSharedDataLoaded() {
        try {
          if (window.SharedDataLoader && !window.SharedDataLoader.isDataLoaded()) {
            await window.SharedDataLoader.loadSharedData();
          }
        } catch (error) {
          console.warn('Shared data loader unavailable when preparing group info page:', error);
        }
      }

      function isNullToken(value) {
        if (value === null || value === undefined) {
          return true;
        }
        if (typeof value === 'string') {
          const trimmed = value.trim();
          return !trimmed || trimmed.toUpperCase() === 'NULL';
        }
        return false;
      }

      function normalizeValue(value) {
        if (value === null || value === undefined) {
          return '';
        }
        if (typeof value === 'string') {
          return value.trim();
        }
        return String(value).trim();
      }

      function escapeHtml(value) {
        const stringValue = String(value ?? '');
        return stringValue.replace(/[&<>"']/g, char => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        })[char] || char);
      }

      function escapeRegExp(value) {
        const stringValue = String(value ?? '');
        return stringValue.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      function normalizeSearchTerm(rawTerm) {
        if (typeof rawTerm !== 'string') {
          return {
            tokens: [],
            combined: ''
          };
        }

        const decoded = rawTerm.normalize('NFKC');
        const squashed = decoded.replace(/[\s\u00A0]+/g, ' ').trim();
        if (!squashed) {
          return {
            tokens: [],
            combined: ''
          };
        }

        const tokens = Array.from(new Set(
          squashed
          .split(' ')
          .map(part => part.trim())
          .filter(Boolean)
          .map(part => part.toLowerCase())
        ));

        const combined = tokens.join('');
        return {
          tokens,
          combined
        };
      }

      function createHighlightRegex(normalized) {
        if (!highlightMatchesEnabled) {
          return null;
        }
        if (!normalized || !normalized.tokens || !normalized.tokens.length) {
          return null;
        }
        try {
          const pattern = normalized.tokens.map(token => escapeRegExp(token)).join('|');
          return new RegExp(pattern, 'gi');
        } catch (error) {
          console.warn('Unable to create highlight regex for tokens:', normalized, error);
          return null;
        }
      }

      function highlightText(value, highlightRegex) {
        const safeValue = escapeHtml(value);
        if (!highlightRegex) {
          return safeValue;
        }
        return safeValue.replace(highlightRegex, match => `<mark class="group-info-highlight">${match}</mark>`);
      }

      function buildItemList(items, options = {}, highlightRegex = null) {
        const normalizedItems = [];
        items.forEach(item => {
          const exploded = splitMultiValue(item);
          if (exploded.length) {
            normalizedItems.push(...exploded.map(part => normalizeValue(part)));
          }
        });

        const filteredItems = normalizedItems.filter(item => !isNullToken(item));

        if (!filteredItems.length) {
          return '';
        }

        const threshold = Number.isFinite(options.multiColumnThreshold) ? options.multiColumnThreshold : 6;
        const multiClass = filteredItems.length >= threshold ? ' group-info-item-list--multi' : '';
        const itemsHtml = filteredItems
          .map(item => `<span class="group-info-item">${highlightText(item, highlightRegex)}</span>`)
          .join('');

        return `<div class="group-info-item-list${multiClass}">${itemsHtml}</div>`;
      }

      function splitMultiValue(value) {
        if (Array.isArray(value)) {
          return value
            .map(item => normalizeValue(item))
            .filter(item => !isNullToken(item));
        }

        const normalized = normalizeValue(value);
        if (isNullToken(normalized)) {
          return [];
        }

        const separators = /[;\n]+/;
        if (!separators.test(normalized)) {
          return [normalized];
        }

        return normalized
          .split(separators)
          .map(item => item.trim())
          .filter(item => item.length > 0 && !isNullToken(item));
      }

      function buildGroupMaps(groupRows, nfrRows) {
        const nfrMap = {};
        if (Array.isArray(nfrRows)) {
          nfrRows.forEach(row => {
            const code = row?.nfr_code || row?.code;
            const description = row?.description;
            const normalizedCode = normalizeValue(code);
            const normalizedDescription = normalizeValue(description);
            if (!isNullToken(normalizedCode) && !isNullToken(normalizedDescription)) {
              nfrMap[normalizedCode] = normalizedDescription;
            }
          });
        }

        const groupMap = {};
        groupRows.forEach(row => {
          const rawTitle = row?.group_title || row?.group_name || row?.name;
          const groupTitle = normalizeValue(rawTitle);
          if (isNullToken(groupTitle)) return;

          if (!groupMap[groupTitle]) {
            groupMap[groupTitle] = {
              name: groupTitle,
              sources: new Set(),
              activities: new Set(),
              nfrCodes: new Set()
            };
          }

          const sourceName = row?.source_name || row?.source || row?.Source;
          const activityName = row?.activity_name || row?.activity || row?.Activity;
          const nfrField = row?.nfr_code || row?.nfr_codes || '';

          const sourceValues = splitMultiValue(sourceName);
          if (sourceValues.length) {
            sourceValues.forEach(item => groupMap[groupTitle].sources.add(item));
          }

          const activityValues = splitMultiValue(activityName);
          if (activityValues.length) {
            activityValues.forEach(item => groupMap[groupTitle].activities.add(item));
          }

          const normalizedNfrField = typeof nfrField === 'string' ? nfrField : String(nfrField ?? '');
          if (normalizedNfrField.trim()) {
            normalizedNfrField
              .split(/[;,\n]/)
              .map(code => code.trim())
              .map(normalizeValue)
              .filter(code => !isNullToken(code))
              .forEach(code => groupMap[groupTitle].nfrCodes.add(code));
          }
        });

        const groups = Object.values(groupMap)
          .map(g => ({
            name: g.name,
            sources: Array.from(g.sources).sort((a, b) => a.localeCompare(b)),
            activities: Array.from(g.activities).sort((a, b) => a.localeCompare(b)),
            nfrCodes: Array.from(g.nfrCodes).sort((a, b) => a.localeCompare(b))
          }))
          .sort((a, b) => {
            if (a.name?.toLowerCase() === 'all') return -1;
            if (b.name?.toLowerCase() === 'all') return 1;
            return a.name.localeCompare(b.name);
          });

        return { groups, nfrMap };
      }

      function collectSourceStrings(group, nfrMap) {
        const results = [];
        if (group.nfrCodes.length) {
          results.push('All Sources from the following NFR Code categories:');
          group.nfrCodes.forEach(code => {
            const description = nfrMap[code];
            results.push(description ? `${code}: ${description}` : code);
          });
        } else if (group.sources.length) {
          results.push(...group.sources);
        } else {
          results.push('All Sources');
        }
        return results;
      }

      function collectFuelStrings(group) {
        if (group.activities.length) {
          return [...group.activities];
        }
        return ['All Fuel Types'];
      }

      function formatSourcesCell(group, nfrMap, highlightRegex) {
        if (group.nfrCodes.length) {
          const nfrItems = group.nfrCodes.map(code => {
            const description = nfrMap[code];
            return description ? `${code}: ${description}` : code;
          });
          const heading = `<span class="group-info-source-heading">${highlightText('All Sources from the following NFR Code categories:', highlightRegex)}</span>`;
          return `${heading}${buildItemList(nfrItems, { multiColumnThreshold: 8 }, highlightRegex)}`;
        }

        if (group.sources.length) {
          return buildItemList(group.sources, { multiColumnThreshold: 8 }, highlightRegex);
        }

        return highlightText('All Sources', highlightRegex);
      }

      function formatFuelCell(group, highlightRegex) {
        if (group.activities.length) {
          return buildItemList(group.activities, { multiColumnThreshold: 8 }, highlightRegex);
        }
        return highlightText('All Fuel Types', highlightRegex);
      }

      function hasActivityData(group) {
        if (!group || !Array.isArray(group.activities)) {
          return false;
        }
        return group.activities.some(item => !isNullToken(item));
      }

      function getActivityIndicatorInfo(group) {
        const hasData = hasActivityData(group);
        const message = hasData ? 'Yes' : 'No';
        const description = hasData ? 'Activity data available' : 'Activity data unavailable';
        const iconSrc = hasData
          ? 'SharedResources/images/Green-Square-Button-White-Tick.svg'
          : 'SharedResources/images/Red-Square-Button-White-Cross.svg';
        return {
          message,
          description,
          iconSrc
        };
      }

      function getSelectedColumnKeys() {
        if (!columnCheckboxes.length) {
          return ['name', 'sources', 'fuels'];
        }

        const checkedValues = columnCheckboxes
          .filter(box => box.checked)
          .map(box => box.value);

        if (checkedValues.includes('all')) {
          return ['name', 'sources', 'fuels'];
        }

        const keys = [];
        if (checkedValues.includes('name')) {
          keys.push('name');
        }
        if (checkedValues.includes('sources')) {
          keys.push('sources');
        }
        if (checkedValues.includes('fuels')) {
          keys.push('fuels');
        }

        return keys;
      }

      function matchesGroup(group, normalizedTerm, columnKeys, nfrMap) {
        if (!normalizedTerm || !normalizedTerm.tokens || !normalizedTerm.tokens.length) {
          return true;
        }
        const tokens = normalizedTerm.tokens;
        const combinedNeedle = normalizedTerm.combined;
        const whitespaceRegex = /[\s\u00A0]+/g;

        if (!columnKeys.length || columnKeys.includes('name')) {
          const lowerName = group.name.toLowerCase();
          const haystack = lowerName.replace(whitespaceRegex, '');
          if (haystack.includes(combinedNeedle)) {
            return true;
          }
          const wordsMatch = tokens.every(token => lowerName.includes(token));
          if (wordsMatch) {
            return true;
          }
        }

        if (!columnKeys.length || columnKeys.includes('sources')) {
          const sourceStrings = collectSourceStrings(group, nfrMap);
          if (sourceStrings.some(entry => entry.toLowerCase().replace(whitespaceRegex, '').includes(combinedNeedle))) {
            return true;
          }
          if (sourceStrings.some(entry => {
            const lowerEntry = entry.toLowerCase();
            return tokens.every(token => lowerEntry.includes(token));
          })) {
            return true;
          }
        }

        if (!columnKeys.length || columnKeys.includes('fuels')) {
          const fuelStrings = collectFuelStrings(group);
          if (fuelStrings.some(entry => entry.toLowerCase().replace(whitespaceRegex, '').includes(combinedNeedle))) {
            return true;
          }
          if (fuelStrings.some(entry => {
            const lowerEntry = entry.toLowerCase();
            return tokens.every(token => lowerEntry.includes(token));
          })) {
            return true;
          }
        }

        return false;
      }

      function renderGroupTable(groupList, options = {}) {
        const highlightRegex = options.highlightRegex || null;
        const selectedColumns = Array.isArray(options.selectedColumns)
          ? options.selectedColumns
          : ['name', 'sources', 'fuels'];
        const applyHighlightToAll = !selectedColumns.length;
        const nameHighlight = (applyHighlightToAll || selectedColumns.includes('name')) ? highlightRegex : null;
        const sourcesHighlight = (applyHighlightToAll || selectedColumns.includes('sources')) ? highlightRegex : null;
        const fuelHighlight = (applyHighlightToAll || selectedColumns.includes('fuels')) ? highlightRegex : null;
        const nfrLookup = groupInfoState ? groupInfoState.nfrMap : {};

        if (!Array.isArray(groupList) || !groupList.length) {
          contentEl.innerHTML = '<p class="text-sm text-gray-600">No groups match the current filter.</p>';
          scheduleHeightUpdate(40);
          return;
        }

        let tableHtml = `
          <table id="groupTable" aria-label="NAEI group information">
            <thead>
              <tr>
                <th>Group Name</th>
                <th class="group-info-activity-column"><span class="group-info-activity-heading" aria-hidden="true">Activity<br>Data</span><span class="sr-only">Activity Data</span></th>
                <th>Sources</th>
                <th>Fuel Types (Activity in NAEI data)</th>
              </tr>
            </thead>
            <tbody>
        `;

        groupList.forEach(group => {
          const activityInfo = getActivityIndicatorInfo(group);
          const sourcesHtml = formatSourcesCell(group, nfrLookup, sourcesHighlight);
          const fuelHtml = formatFuelCell(group, fuelHighlight);
          tableHtml += `
            <tr>
              <td style="font-weight:600;">${highlightText(group.name, nameHighlight)}</td>
              <td class="group-info-activity-cell" data-copy-text="${escapeHtml(activityInfo.description)}">
                <img src="${activityInfo.iconSrc}" alt="" class="group-info-activity-icon" width="24" height="24" loading="lazy">
                <span class="sr-only">${escapeHtml(activityInfo.description)}</span>
              </td>
              <td>${sourcesHtml}</td>
              <td>${fuelHtml}</td>
            </tr>
          `;
        });

        tableHtml += '</tbody></table>';
        contentEl.innerHTML = tableHtml;

        const tableEl = contentEl.querySelector('table');
        attachCopyHandlers(tableEl, groupInfoState?.usedSupabase);
        scheduleHeightUpdate(60);
      }

      function applyGroupFilters() {
        if (!groupInfoState) {
          return;
        }

        const rawTerm = filterInput ? filterInput.value : '';
        const normalizedTerm = normalizeSearchTerm(rawTerm);
        const columnKeys = getSelectedColumnKeys();
        let filteredGroups;
        let highlightRegex = null;

        if (!columnKeys.length) {
          filteredGroups = groupInfoState.groups.slice();
        } else {
          filteredGroups = groupInfoState.groups.filter(group => matchesGroup(group, normalizedTerm, columnKeys, groupInfoState.nfrMap));
          highlightRegex = createHighlightRegex(normalizedTerm);
        }

        renderGroupTable(filteredGroups, {
          highlightRegex: columnKeys.length ? highlightRegex : null,
          selectedColumns: columnKeys
        });

        setFilterInputState(columnKeys.length > 0);
      }

      function handleColumnCheckboxChange(changedBox) {
        if (!changedBox) {
          return;
        }

        const allBox = columnCheckboxes.find(box => box.value === 'all');
        const dataBoxes = columnCheckboxes.filter(box => box.value !== 'all');

        if (changedBox.value === 'all') {
          const shouldCheck = changedBox.checked;
          dataBoxes.forEach(box => {
            box.checked = shouldCheck;
          });
        } else {
          if (allBox) {
            if (!changedBox.checked) {
              allBox.checked = false;
            } else {
              allBox.checked = dataBoxes.every(box => box.checked);
            }
          }
        }

        setFilterInputState(getSelectedColumnKeys().length > 0);
      }

      let filterControlsInitialized = false;

      function setupFilterControls() {
        if (filterControlsInitialized) {
          return;
        }

        if (filterInput) {
          filterInput.addEventListener('input', () => {
            if (!isFilterInputActive()) return;
            applyGroupFilters();
          });
          filterInput.addEventListener('search', () => {
            if (!isFilterInputActive()) return;
            applyGroupFilters();
          });
        }

        columnCheckboxes.forEach(box => {
          box.addEventListener('change', event => {
            handleColumnCheckboxChange(event.currentTarget);
            applyGroupFilters();
          });
        });

        setFilterInputState(getSelectedColumnKeys().length > 0);

        filterControlsInitialized = true;
      }

      function attachCopyHandlers(tableEl, usedSupabase) {
        if (!tableEl) return;

        tableEl.addEventListener('click', event => {
          const row = event.target.closest('tbody tr');
          if (!row) return;

          const textToCopy = Array.from(row.cells)
            .map(cell => {
              if (cell?.dataset?.copyText) {
                return cell.dataset.copyText.trim();
              }
              return cell.innerText.trim();
            })
            .filter(Boolean)
            .join('\n\n');

          if (!textToCopy) return;

          const successMessage = 'Copied group details to clipboard.';

          const onSuccess = () => {
            setStatus(successMessage, false);
            scheduleHeightUpdate(20);
          };

          const fallbackCopy = () => {
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.setAttribute('readonly', '');
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            const selection = document.getSelection();
            const priorRange = selection && selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
            textarea.select();
            try {
              const ok = document.execCommand('copy');
              if (ok) {
                onSuccess();
              } else {
                console.warn('document.execCommand copy returned false');
              }
            } catch (error) {
              console.warn('Fallback copy failed:', error);
            }
            document.body.removeChild(textarea);
            if (priorRange && selection) {
              selection.removeAllRanges();
              selection.addRange(priorRange);
            }
          };

          if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            navigator.clipboard.writeText(textToCopy)
              .then(onSuccess)
              .catch(error => {
                console.warn('navigator.clipboard.writeText failed:', error);
                fallbackCopy();
              });
          } else {
            fallbackCopy();
          }

          clearTimeout(statusTimer);
          statusTimer = setTimeout(() => {
            setStatus('', true);
          }, 3200);
        });
      }

      async function loadGroupInfo() {
        setStatus('Loading group information…', true);
        contentEl.textContent = 'Loading group information…';

        await ensureSharedDataLoaded();

        let groupRows = [];
        let nfrRows = [];
        let usedSupabase = false;

        try {
          if (window.SharedDataLoader && window.SharedDataLoader.isDataLoaded()) {
            const cached = window.SharedDataLoader.getCachedData();
            if (cached && Array.isArray(cached.groups) && cached.groups.length) {
              groupRows = cached.groups.slice();
            }
          }
        } catch (error) {
          console.warn('Unable to access cached group information:', error);
        }

        try {
          const client = window.SupabaseConfig ? window.SupabaseConfig.initSupabaseClient() : null;
          if (client) {
            const [groupResp, nfrResp] = await Promise.all([
              client.from('NAEI_global_t_Group').select('id,group_title,source_name,activity_name,nfr_code'),
              client.from('NAEI_global_t_NFRCode').select('nfr_code,description')
            ]);

            if (!groupResp?.error && Array.isArray(groupResp?.data) && groupResp.data.length) {
              groupRows = groupResp.data;
              usedSupabase = true;
            } else if (groupResp?.error) {
              console.warn('Supabase group info query failed:', groupResp.error);
            }

            if (!nfrResp?.error && Array.isArray(nfrResp?.data) && nfrResp.data.length) {
              nfrRows = nfrResp.data;
              usedSupabase = true;
            } else if (nfrResp?.error) {
              console.warn('Supabase NFR code query failed:', nfrResp.error);
            }
          } else {
            console.warn('Supabase client unavailable when loading group info. Relying on cached data.');
          }
        } catch (error) {
          console.warn('Error loading group information from Supabase:', error);
        }

        if (!groupRows.length) {
          contentEl.innerHTML = "<p class='text-red-600 font-semibold'>⚠️ Unable to load group information right now. Please try again later.</p>";
          setStatus('', true);
          scheduleHeightUpdate();
          return;
        }

        const { groups, nfrMap } = buildGroupMaps(groupRows, nfrRows);

        if (!groups.length) {
          contentEl.innerHTML = "<p class='text-red-600 font-semibold'>⚠️ No group information is available.</p>";
          setStatus('', true);
          scheduleHeightUpdate();
          return;
        }

        groupInfoState = {
          groups,
          nfrMap,
          usedSupabase
        };

        setupFilterControls();
        applyGroupFilters();
        setStatus('', true);
      }

      document.addEventListener('DOMContentLoaded', () => {
        loadGroupInfo().catch(error => {
          console.error('Failed to load group info page:', error);
          contentEl.innerHTML = "<p class='text-red-600 font-semibold'>⚠️ Something went wrong while loading group information.</p>";
          setStatus('', true);
          scheduleHeightUpdate();
        });
      });

      window.addEventListener('message', event => {
        if (event?.data?.type === 'requestHeight') {
          scheduleHeightUpdate(10);
        }
      });

      window.addEventListener('load', () => {
        scheduleHeightUpdate(20);
      });
    })();
  </script>
</body>
</html>
