<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NAEI Group Information</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="dist/tailwind.css">
  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #ffffff;
      color: #1f2937;
      margin: 0;
      padding: 0;
    }

    #groupTable {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.95rem;
      color: #0f172a;
      font-family: inherit;
    }

    #groupTable th,
    #groupTable td {
      border: 1px solid #444;
      padding: 12px;
      text-align: left;
      vertical-align: top;
      white-space: pre-line;
    }

    #groupTable thead tr {
      background: #d0d0d0;
    }

    #groupTable tbody tr {
      cursor: pointer;
    }

    #groupTable tbody tr:hover {
      background: #f5f5f5;
    }

    #groupTable th:nth-child(1),
    #groupTable td:nth-child(1) {
      width: 25%;
    }

    #groupTable th:nth-child(2),
    #groupTable td:nth-child(2) {
      width: 40%;
    }

    #groupTable th:nth-child(3),
    #groupTable td:nth-child(3) {
      width: 35%;
    }

    .group-info-source-heading {
      text-decoration: underline;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    .group-info-item-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 4px;
    }

    .group-info-item {
      display: block;
      line-height: 1.25;
    }

    @media (min-width: 980px) {
      .group-info-item-list--multi {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .group-info-shell {
      padding: 28px 28px 40px;
    }

    .group-info-frame {
      width: calc(100% - 140px);
      margin: 0 auto 0 0;
      border-radius: 6px;
      background: #ffffff;
      box-sizing: border-box;
      padding: 28px 32px 36px;
      overflow: hidden;
      box-shadow: none;
      border: none;
    }

    .group-info-header {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
      gap: 10px;
      margin-bottom: 6px;
    }

    .group-info-title-main {
      font-size: 28px;
      font-weight: 700;
      line-height: 1.1;
      color: #0f172a;
    }

    .group-info-filter-block {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 28px 0 16px;
      max-width: 100%;
    }

    .group-info-filter-label {
      font-size: 20px;
      font-weight: 600;
      color: #1f2937;
    }

    .group-info-filter-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 1rem;
      font-family: inherit;
      color: #0f172a;
      background-color: #fff;
    }

    .group-info-filter-input:focus {
      outline: 2px solid #ff9301;
      outline-offset: 1px;
    }

    .group-info-column-filters {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 24px;
    }

    .group-info-column-label {
      font-size: 0.95rem;
      font-weight: 600;
      color: #1f2937;
    }

    .group-info-column-options {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
    }

    .group-info-column-option {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.95rem;
      color: #1f2937;
    }

    .group-info-table-container {
      margin-top: 18px;
      overflow-x: auto;
    }

    .status-text {
      font-size: 0.75rem;
      color: #6b7280;
      min-height: 1.25rem;
      margin-bottom: 16px;
    }

    @media (max-width: 1100px) {
      .group-info-frame {
        width: 100%;
        padding: 24px 24px 32px;
      }

      .group-info-shell {
        padding: 24px 20px 32px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="SharedResources/supabase-config.js"></script>
  <script src="SharedResources/shared-data-loader.js"></script>
</head>
<body>
  <main class="group-info-shell">
    <section class="group-info-frame" aria-labelledby="group-info-heading">
      <header class="group-info-header">
        <div class="group-info-title-main" id="group-info-heading">Group Information</div>
      </header>

      <div class="group-info-filter-block">
        <label for="group-info-filter-input" class="group-info-filter-label">Filter</label>
        <input type="search" id="group-info-filter-input" class="group-info-filter-input" placeholder="Search groups, sources, or fuel types" autocomplete="off" aria-describedby="group-info-filter-columns-label">
      </div>

      <div class="group-info-column-filters" role="group" aria-labelledby="group-info-filter-columns-label">
        <span class="group-info-column-label" id="group-info-filter-columns-label">Filter Columns</span>
        <div class="group-info-column-options">
          <label class="group-info-column-option">
            <input type="checkbox" id="group-info-filter-column-all" value="all" checked>
            <span>All</span>
          </label>
          <label class="group-info-column-option">
            <input type="checkbox" id="group-info-filter-column-name" value="name" checked>
            <span>Group Name</span>
          </label>
          <label class="group-info-column-option">
            <input type="checkbox" id="group-info-filter-column-sources" value="sources" checked>
            <span>Sources &amp; NFR Code</span>
          </label>
          <label class="group-info-column-option">
            <input type="checkbox" id="group-info-filter-column-fuels" value="fuels" checked>
            <span>Fuel Types</span>
          </label>
        </div>
      </div>

      <p id="group-info-status" class="status-text" aria-live="polite"></p>

      <div class="group-info-table-container">
        <div id="group-info-content">
          Loading group information…
        </div>
      </div>
    </section>
  </main>

  <script>
    (function() {
      const statusEl = document.getElementById('group-info-status');
      const contentEl = document.getElementById('group-info-content');
      let statusTimer = null;

      function setStatus(message, persist = false) {
        if (!statusEl) return;
        statusEl.textContent = message || '';
        if (!persist) {
          clearTimeout(statusTimer);
          statusTimer = setTimeout(() => {
            statusEl.textContent = '';
          }, 4000);
        }
      }

      function measureHeight() {
        const body = document.body;
        const docEl = document.documentElement;
        let height = Math.max(
          body ? body.scrollHeight : 0,
          body ? body.offsetHeight : 0,
          docEl ? docEl.scrollHeight : 0,
          docEl ? docEl.offsetHeight : 0,
          600
        );
        if (!Number.isFinite(height) || height <= 0) {
          height = 800;
        }
        return height;
      }

      function sendHeightToParent() {
        try {
          const height = measureHeight();
          window.parent.postMessage({
            type: 'contentHeight',
            chart: 'group-info',
            height
          }, '*');
        } catch (error) {
          console.warn('Unable to send group info height to parent:', error);
        }
      }

      function scheduleHeightUpdate(delay = 50) {
        setTimeout(() => {
          requestAnimationFrame(sendHeightToParent);
        }, delay);
      }

      async function ensureSharedDataLoaded() {
        try {
          if (window.SharedDataLoader && !window.SharedDataLoader.isDataLoaded()) {
            await window.SharedDataLoader.loadSharedData();
          }
        } catch (error) {
          console.warn('Shared data loader unavailable when preparing group info page:', error);
        }
      }

      function isNullToken(value) {
        if (value === null || value === undefined) {
          return true;
        }
        if (typeof value === 'string') {
          const trimmed = value.trim();
          return !trimmed || trimmed.toUpperCase() === 'NULL';
        }
        return false;
      }

      function normalizeValue(value) {
        if (value === null || value === undefined) {
          return '';
        }
        if (typeof value === 'string') {
          return value.trim();
        }
        return String(value).trim();
      }

      function escapeHtml(value) {
        return value.replace(/[&<>"']/g, char => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        })[char] || char);
      }

      function buildItemList(items, options = {}) {
        const normalizedItems = [];
        items.forEach(item => {
          const exploded = splitMultiValue(item);
          if (exploded.length) {
            normalizedItems.push(...exploded.map(part => normalizeValue(part)));
          }
        });

        const filteredItems = normalizedItems.filter(item => !isNullToken(item));

        if (!filteredItems.length) {
          return '';
        }

        const threshold = Number.isFinite(options.multiColumnThreshold) ? options.multiColumnThreshold : 6;
        const multiClass = filteredItems.length >= threshold ? ' group-info-item-list--multi' : '';
        const itemsHtml = filteredItems
          .map(item => `<span class="group-info-item">${escapeHtml(item)}</span>`)
          .join('');

        return `<div class="group-info-item-list${multiClass}">${itemsHtml}</div>`;
      }

      function splitMultiValue(value) {
        if (Array.isArray(value)) {
          return value
            .map(item => normalizeValue(item))
            .filter(item => !isNullToken(item));
        }

        const normalized = normalizeValue(value);
        if (isNullToken(normalized)) {
          return [];
        }

        const separators = /[;\n]+/;
        if (!separators.test(normalized)) {
          return [normalized];
        }

        return normalized
          .split(separators)
          .map(item => item.trim())
          .filter(item => item.length > 0 && !isNullToken(item));
      }

      function buildGroupMaps(groupRows, nfrRows) {
        const nfrMap = {};
        if (Array.isArray(nfrRows)) {
          nfrRows.forEach(row => {
            const code = row?.nfr_code || row?.code;
            const description = row?.description;
            const normalizedCode = normalizeValue(code);
            const normalizedDescription = normalizeValue(description);
            if (!isNullToken(normalizedCode) && !isNullToken(normalizedDescription)) {
              nfrMap[normalizedCode] = normalizedDescription;
            }
          });
        }

        const groupMap = {};
        groupRows.forEach(row => {
          const rawTitle = row?.group_title || row?.group_name || row?.name;
          const groupTitle = normalizeValue(rawTitle);
          if (isNullToken(groupTitle)) return;

          if (!groupMap[groupTitle]) {
            groupMap[groupTitle] = {
              name: groupTitle,
              sources: new Set(),
              activities: new Set(),
              nfrCodes: new Set()
            };
          }

          const sourceName = row?.source_name || row?.source || row?.Source;
          const activityName = row?.activity_name || row?.activity || row?.Activity;
          const nfrField = row?.nfr_code || row?.nfr_codes || '';

          const sourceValues = splitMultiValue(sourceName);
          if (sourceValues.length) {
            sourceValues.forEach(item => groupMap[groupTitle].sources.add(item));
          }

          const activityValues = splitMultiValue(activityName);
          if (activityValues.length) {
            activityValues.forEach(item => groupMap[groupTitle].activities.add(item));
          }

          const normalizedNfrField = typeof nfrField === 'string' ? nfrField : String(nfrField ?? '');
          if (normalizedNfrField.trim()) {
            normalizedNfrField
              .split(/[;,\n]/)
              .map(code => code.trim())
              .map(normalizeValue)
              .filter(code => !isNullToken(code))
              .forEach(code => groupMap[groupTitle].nfrCodes.add(code));
          }
        });

        const groups = Object.values(groupMap)
          .map(g => ({
            name: g.name,
            sources: Array.from(g.sources).sort((a, b) => a.localeCompare(b)),
            activities: Array.from(g.activities).sort((a, b) => a.localeCompare(b)),
            nfrCodes: Array.from(g.nfrCodes).sort((a, b) => a.localeCompare(b))
          }))
          .sort((a, b) => {
            if (a.name?.toLowerCase() === 'all') return -1;
            if (b.name?.toLowerCase() === 'all') return 1;
            return a.name.localeCompare(b.name);
          });

        return { groups, nfrMap };
      }

      function attachCopyHandlers(tableEl, usedSupabase) {
        if (!tableEl) return;

        tableEl.addEventListener('click', event => {
          const row = event.target.closest('tbody tr');
          if (!row) return;

          const textToCopy = Array.from(row.cells)
            .map(cell => cell.innerText.trim())
            .filter(Boolean)
            .join('\n\n');

          if (!textToCopy) return;

          const successMessage = 'Copied group details to clipboard.';

          const onSuccess = () => {
            setStatus(successMessage, false);
            scheduleHeightUpdate(20);
          };

          const fallbackCopy = () => {
            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.setAttribute('readonly', '');
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            const selection = document.getSelection();
            const priorRange = selection && selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
            textarea.select();
            try {
              const ok = document.execCommand('copy');
              if (ok) {
                onSuccess();
              } else {
                console.warn('document.execCommand copy returned false');
              }
            } catch (error) {
              console.warn('Fallback copy failed:', error);
            }
            document.body.removeChild(textarea);
            if (priorRange && selection) {
              selection.removeAllRanges();
              selection.addRange(priorRange);
            }
          };

          if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            navigator.clipboard.writeText(textToCopy)
              .then(onSuccess)
              .catch(error => {
                console.warn('navigator.clipboard.writeText failed:', error);
                fallbackCopy();
              });
          } else {
            fallbackCopy();
          }

          clearTimeout(statusTimer);
          statusTimer = setTimeout(() => {
            setStatus('', true);
          }, 3200);
        });
      }

      async function loadGroupInfo() {
        setStatus('Loading group information…', true);
        contentEl.textContent = 'Loading group information…';

        await ensureSharedDataLoaded();

        let groupRows = [];
        let nfrRows = [];
        let usedSupabase = false;

        try {
          if (window.SharedDataLoader && window.SharedDataLoader.isDataLoaded()) {
            const cached = window.SharedDataLoader.getCachedData();
            if (cached && Array.isArray(cached.groups) && cached.groups.length) {
              groupRows = cached.groups.slice();
            }
          }
        } catch (error) {
          console.warn('Unable to access cached group information:', error);
        }

        try {
          const client = window.SupabaseConfig ? window.SupabaseConfig.initSupabaseClient() : null;
          if (client) {
            const [groupResp, nfrResp] = await Promise.all([
              client.from('NAEI_global_t_Group').select('id,group_title,source_name,activity_name,nfr_code'),
              client.from('NAEI_global_t_NFRCode').select('nfr_code,description')
            ]);

            if (!groupResp?.error && Array.isArray(groupResp?.data) && groupResp.data.length) {
              groupRows = groupResp.data;
              usedSupabase = true;
            } else if (groupResp?.error) {
              console.warn('Supabase group info query failed:', groupResp.error);
            }

            if (!nfrResp?.error && Array.isArray(nfrResp?.data) && nfrResp.data.length) {
              nfrRows = nfrResp.data;
              usedSupabase = true;
            } else if (nfrResp?.error) {
              console.warn('Supabase NFR code query failed:', nfrResp.error);
            }
          } else {
            console.warn('Supabase client unavailable when loading group info. Relying on cached data.');
          }
        } catch (error) {
          console.warn('Error loading group information from Supabase:', error);
        }

        if (!groupRows.length) {
          contentEl.innerHTML = "<p class='text-red-600 font-semibold'>⚠️ Unable to load group information right now. Please try again later.</p>";
          setStatus('', true);
          scheduleHeightUpdate();
          return;
        }

        const { groups, nfrMap } = buildGroupMaps(groupRows, nfrRows);

        if (!groups.length) {
          contentEl.innerHTML = "<p class='text-red-600 font-semibold'>⚠️ No group information is available.</p>";
          setStatus('', true);
          scheduleHeightUpdate();
          return;
        }

        let tableHtml = `
          <table id="groupTable" aria-label="NAEI group information">
            <thead>
              <tr>
                <th>Group Name</th>
                <th>Sources</th>
                <th>Fuel Types (Activity in NAEI data)</th>
              </tr>
            </thead>
            <tbody>
        `;

        groups.forEach(group => {
          const validSources = group.sources;
          const validActivities = group.activities;
          const validCodes = group.nfrCodes;

          let sourcesContent = '';
          if (validCodes.length) {
            const nfrItems = validCodes.map(code => {
              const description = nfrMap[code];
              return description ? `${code}: ${description}` : code;
            });
            sourcesContent += '<span class="group-info-source-heading">All Sources from the following NFR Code categories:</span>';
            sourcesContent += buildItemList(nfrItems, { multiColumnThreshold: 8 });
          }

          if (!sourcesContent) {
            sourcesContent = validSources.length ? buildItemList(validSources, { multiColumnThreshold: 8 }) : 'All Sources';
          }

          const activitiesContent = validActivities.length
            ? buildItemList(validActivities, { multiColumnThreshold: 8 })
            : 'All Fuel Types';

          tableHtml += `
            <tr>
              <td style="font-weight:600;">${group.name}</td>
              <td>${sourcesContent}</td>
              <td>${activitiesContent}</td>
            </tr>
          `;
        });

        tableHtml += '</tbody></table>';
        contentEl.innerHTML = tableHtml;

        const tableEl = contentEl.querySelector('table');
        attachCopyHandlers(tableEl, usedSupabase);

        setStatus('', true);
        scheduleHeightUpdate();
      }

      document.addEventListener('DOMContentLoaded', () => {
        loadGroupInfo().catch(error => {
          console.error('Failed to load group info page:', error);
          contentEl.innerHTML = "<p class='text-red-600 font-semibold'>⚠️ Something went wrong while loading group information.</p>";
          setStatus('', true);
          scheduleHeightUpdate();
        });
      });

      window.addEventListener('message', event => {
        if (event?.data?.type === 'requestHeight') {
          scheduleHeightUpdate(10);
        }
      });

      window.addEventListener('load', () => {
        scheduleHeightUpdate(20);
      });
    })();
  </script>
</body>
</html>
