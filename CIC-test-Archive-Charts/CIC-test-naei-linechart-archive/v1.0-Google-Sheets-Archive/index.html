<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NAEI Multi-Group Pollutant Viewer</title>
  <link rel="icon" type="image/png" sizes="64x64" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Social preview / link preview meta tags -->
  <meta name="description" content="NAEI Multi-Group Pollutant Viewer">
  <!-- Open Graph (Facebook, LinkedIn, Slack, etc.) -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="NAEI Multi-Group Pollutant Viewer">
  <meta property="og:description" content="Compare emissions from grouped NAEI sources across years. Interactive charts, CSV/XLSX export and downloadable images.">
  <meta property="og:url" content="https://github.com/Chronic-Illness-Channel/naei-multigroup-viewer">
  <meta property="og:image" content="https://raw.githubusercontent.com/Chronic-Illness-Channel/naei-multigroup-viewer/4edd238fc210f2019c4d6b9101bee18172148270/CIC%20-%20NAEI%20Multi-Group%20Viewer%20Thumbnail.1120x630.png">
  <meta property="og:image:width" content="1120">
  <meta property="og:image:height" content="630">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="NAEI Multi-Group Pollutant Viewer">
<meta name="twitter:description" content="Compare emissions from grouped NAEI sources across years.">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Chronic-Illness-Channel/naei-multigroup-viewer/4edd238fc210f2019c4d6b9101bee18172148270/CIC%20-%20NAEI%20Multi-Group%20Viewer%20Thumbnail.1120x630.png">
<meta name="twitter:site" content="@Chronic_Channel">
<meta name="twitter:creator" content="@Chronic_Channel">
  <!-- Legacy image hint -->
  <link rel="image_src" href="https://raw.githubusercontent.com/Chronic-Illness-Channel/naei-multigroup-viewer/4edd238fc210f2019c4d6b9101bee18172148270/CIC%20-%20NAEI%20Multi-Group%20Viewer%20Thumbnail.1120x630.png">

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <!-- (rest of your existing styles/scripts follow) -->
</head>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; color: #000; background:#fff; }
    label { font-weight:600; margin-right:6px; }
	#cicLogo {
	  position: absolute;
	  top: 10px;
	  right: 10px;
	  width: 80px; /* adjust size if needed */
	  height: auto;
	  z-index: 100;
	}
	
    select, button { margin:6px; padding:6px 10px; border-radius:6px; border:1px solid #ccc; }
    h2 { margin-bottom:8px; }
    #groupContainer { margin-top:10px; }
    .groupRow { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .groupRow.dragging { opacity:0.5; }
    .dragHandle { cursor:grab; user-select:none; padding:4px 6px; background:#f0f0f0; border-radius:6px; }
    #chartTitle { font-weight:700; font-size:18px; margin-top:8px; margin-bottom:6px; text-align:center; }
    #chart_div { width:100%; height:60vh; margin-top:0; opacity:0; transition:opacity .35s ease; min-height:40vh; border:1px solid #eee; border-radius:6px; padding:6px; box-sizing:border-box; }
    #chart_div.visible { opacity:1; }
    button { background:#EFEFEF; cursor:pointer; }
    button:hover { background:#E0E0E0; }
    button:disabled { background:#EEE; color:#666; cursor:not-allowed; }
    .add-btn, .remove-btn { display:inline-flex; align-items:center; gap:6px; }
    .remove-icon { display:inline-block; width:18px; height:18px; border-radius:50%; background:#d33; color:#fff; text-align:center; line-height:18px; font-weight:bold; }
    .add-btn .add-icon { color:#4CAF50; font-weight:bold; font-size:2em; }
    .add-btn:hover .add-icon { color:#45a049; }
    #loadingOverlay { position:fixed; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(255,255,255,0.98); z-index:9999; transition:opacity .35s ease; }
    .spinner { width:72px; height:72px; border-radius:50%; background: conic-gradient(#E6194B 0deg 120deg,#F58231 120deg 240deg,#FFE119 240deg 360deg); animation:spin 1.25s linear infinite; box-shadow:0 0 12px rgba(0,0,0,0.08); }
    @keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
    .loading-text { margin-top:12px; color:#333; font-weight:600; }
    #mainContent { display:none; opacity:0; transition:opacity .4s ease; }
    #mainContent.loaded { opacity:1; }
	/* --- Legend dot alignment fix --- */
	#customLegend {
	  margin-top: 10px;
	  display: flex;
	  flex-wrap: wrap;
	  justify-content: center;
	  align-items: center;
	  font-family: system-ui, sans-serif;
	  gap: 10px; /* space between legend items */
	}

	#customLegend span {
	  display: inline-flex;
	  align-items: center;     /* centers dot + text vertically */
	  gap: 4px;                /* tighter gap between dot and text */
	  margin: 4px 8px;         /* small spacing between items */
	  cursor: pointer;
	  font-weight: 600;
	  line-height: 1;
	  user-select: none;
	}

	#customLegend span > span {
	  width: 10px;             /* smaller dot */
	  height: 10px;
	  border-radius: 50%;
	  flex-shrink: 0;
	  transform: translateY(1px); /* tiny vertical optical fix */
	}
	
	/* --- Footer centering fix --- */
	footer {
	  width: 100%;
	  text-align: center;
	  font-size: 12px;
	  color: #555;
	  margin-top: 8px;
	  line-height: 1.4;
	  font-family: system-ui, sans-serif;
	}

	footer a {
	  color: #3366cc;
	  text-decoration: none;
	}

	footer a:hover {
	  text-decoration: underline;
	}
	
  </style>
</head>

<body>
  <div id="loadingOverlay">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loading-text">Loading data, please wait‚Ä¶</div>
  </div>

<img id="cicLogo" src="CIC - Square - Border - Words - Alpha 360x360.png" alt="CIC Logo">


  <div id="mainContent" aria-hidden="true">
    <h2>NAEI Multi-Group Pollutant Viewer</h2>
<details class="my-4 bg-gray-50 border border-gray-300 rounded-2xl p-4 shadow-sm">
  <summary class="cursor-pointer text-lg font-semibold text-blue-700 hover:text-blue-900">
    üß≠ How to Use the NAEI Multi-Group Pollutant Viewer
  </summary>

  <div class="mt-3 space-y-3 text-gray-800 leading-relaxed">
    <p>
      The NAEI Multi-Group Pollutant Viewer is built from data published by the National Atmospheric Emissions Inventory (NAEI), combining one or more sources and fuel types into groups to make emissions easier to explore and compare.
    </p>

    <h3 class="font-semibold text-blue-700">1Ô∏è‚É£ Select a Pollutant</h3>
    <p>
      Use the <strong>Pollutant dropdown</strong> at the top to choose which pollutant you want to view (e.g., PM2.5, CO‚ÇÇ, NOx, etc.).<br>
      Once selected, the chart and group options update automatically.
    </p>

    <h3 class="font-semibold text-blue-700">2Ô∏è‚É£ Choose Emission Groups</h3>
    <p>
      Click <strong>‚Äú+ Add Group‚Äù</strong> to add a new group comparison (e.g., Road Transport, Power Stations, Domestic Combustion).<br>
      You can add up to <strong>10 groups</strong> to compare at once.<br>
      To remove a group, click <strong>‚Äú‚àí Remove Group‚Äù</strong> next to it (this appears when two or more groups are selected).
    </p>
    <p class="italic text-sm text-gray-600">
      üí° Tip: You can re-order the group boxes by clicking and dragging the ‚†ø handle next to each group ‚Äî the chart updates automatically.
    </p>

    <h3 class="font-semibold text-blue-700">3Ô∏è‚É£ Set the Year Range</h3>
    <p>
      Use the <strong>Start Year</strong> and <strong>End Year</strong> dropdowns to focus on a particular time period.<br>
      The chart will automatically refresh to show data for the chosen range.
    </p>

    <h3 class="font-semibold text-blue-700">4Ô∏è‚É£ View and Interact with the Chart</h3>
    <p>
      Once you‚Äôve chosen your pollutant, groups, and years, the interactive line chart will appear.<br>
      <strong>Hover</strong> over any point on the chart to see the exact emission value for that year.<br>
      The <strong>Y-axis</strong> shows total emissions, including units (e.g., kilotonnes).<br>
      Each group is shown in a unique colour.
    </p>

    <h3 class="font-semibold text-blue-700">5Ô∏è‚É£ Use the Legend to Toggle Lines</h3>
    <p>
      Above the chart, the legend lists all groups and their corresponding colours.<br>
      <strong>Click a group name</strong> in the legend to hide or show that group‚Äôs line on the chart.<br>
      Faded items indicate hidden or unavailable data.<br>
      <em>(Groups labelled ‚Äú(No data available)‚Äù are included for reference but contain no plotted values.)</em>
    </p>

    <h3 class="font-semibold text-blue-700">6Ô∏è‚É£ Smooth or Straight Lines</h3>
    <p>
      Click the <strong>‚Äúüö´ Disable Smoothing‚Äù</strong> button to switch to straight (non-curved) lines.<br>
      Click again (the button will change to <strong>‚Äú‚úÖ Enable Smoothing‚Äù</strong>) to re-enable smooth, curved lines.
    </p>

    <h3 class="font-semibold text-blue-700">7Ô∏è‚É£ Download Options</h3>
    <p>You can export both the chart and the data for your own analysis or reporting.</p>

    <p>
      <strong>üìä Download Chart as PNG</strong><br>
      Click <strong>‚Äú‚¨áÔ∏è Download Chart as PNG‚Äù</strong> to save the chart as an image.<br>
      The export includes:
      <ul class="list-disc list-inside ml-4">
        <li>The chart</li>
        <li>The custom colour legend</li>
        <li>The pollutant name and emission unit</li>
        <li>A small Defra/DESNZ footer and the CIC logo</li>
      </ul>
    </p>

    <p>
      <strong>üìÑ Download Data</strong><br>
      <strong>CSV:</strong> Click ‚ÄúüìÑ Download Data ‚Äì CSV‚Äù for a spreadsheet-compatible text file.<br>
      <strong>Excel:</strong> Click ‚Äúüìä Download Data ‚Äì Excel‚Äù for a formatted Excel workbook.<br>
      Each data file includes:
      <ul class="list-disc list-inside ml-4">
        <li>A first line showing the pollutant name and emission unit</li>
        <li>A table with groups as rows and years as columns</li>
        <li>A footer row with the download timestamp</li>
      </ul>
    </p>
<h3 class="font-semibold text-blue-700">8Ô∏è‚É£ View Group Details</h3>
<p>
  Use the <strong>‚Äúüìò See Group Info‚Äù</strong> section below the group selector to view details of how each group is built.<br>
  This table shows the <strong>Source Names</strong> and <strong>Fuel Types</strong>, from the NAEI data, that have been combined to create each group.<br>
  If a group includes all sources or all fuel types, these will be shown as <em>‚ÄúAll Sources‚Äù</em> or <em>‚ÄúAll Fuel Types‚Äù</em> respectively.
</p>
	
    <h3 class="font-semibold text-blue-700">9Ô∏è‚É£ Licensing and Attribution</h3>
    <p>
      ¬© Crown copyright (Defra & DESNZ) and available under the
      <strong>Open Government Licence (OGL)</strong>.<br>
      See links in the page footer for full details.
    </p>
  </div>
</details>

    <div>
      <label for="pollutantSelect">Pollutant:</label>
      <select id="pollutantSelect"><option value="">Select pollutant</option></select>
    </div>

    <div id="groupContainer"></div>

<details class="my-4 bg-gray-50 border border-gray-300 rounded-2xl p-4 shadow-sm">
  <summary class="cursor-pointer text-lg font-semibold text-blue-700 hover:text-blue-900">
    üìò See Group Info
  </summary>

  <div id="group-info" class="mt-3 text-gray-800 leading-relaxed overflow-x-auto">
    <p>Loading group information...</p>
  </div>
</details>

    <div>
      <label for="startYear">Start Year:</label>
      <select id="startYear"></select>

      <label for="endYear">End Year:</label>
      <select id="endYear"></select>

      <button id="downloadBtn">‚¨áÔ∏è Download Chart as PNG</button>
	  <button id="toggleSmoothBtn">üö´ Disable Smoothing</button>
	  <button id="downloadCSVBtn">üìÑ Download Data - CSV</button>
	  <button id="downloadXLSXBtn">üìä Download Data - Excel</button>

	  
    </div>

    <div id="chartTitle" aria-hidden="true"></div>
    <div id="customLegend" aria-hidden="true"></div>
    <div id="chart_div" role="img" aria-label="Pollutant time series chart"></div>
<footer>
  ¬© Crown 2025 copyright Defra &amp; DESNZ via 
  <a href="https://naei.energysecurity.gov.uk" target="_blank" rel="noopener">naei.energysecurity.gov.uk</a> 
  licensed under the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank" rel="noopener">Open Government Licence (OGL)</a>.
  <br>
  <span style="font-size: 0.8em; color: #666; margin-top: 4px; display: inline-block;">
    Version: v1.0 ‚Ä¢ Build: 2025.10.20
  </span>
</footer>

  </div>

<script>
google.charts.load('current', {packages:['corechart']});

// Data URLs (your gviz endpoints)
const DATA_SHEET_URL='https://docs.google.com/spreadsheets/d/1m0as8iV7quPhM5fg_8fJpzAEQh_LBBDFwnuzf71QJZM/gviz/tq?sheet=23ds_group_data&tq=SELECT%20*';
const UNIT_SHEET_URL='https://docs.google.com/spreadsheets/d/1m0as8iV7quPhM5fg_8fJpzAEQh_LBBDFwnuzf71QJZM/gviz/tq?sheet=Pollutant&tq=SELECT%20*';

let globalRows=[], globalHeaders=[], pollutantUnits={}, groupedData={};
const distinctPalette=['#E6194B','#3CB44B','#FFE119','#4363D8','#F58231','#911EB4','#46F0F0','#F032E6','#BCF60C','#FABEBE'];
const categoryBaseColor={ecodesign:distinctPalette[4],fireplace:distinctPalette[0],gas:distinctPalette[3],power:distinctPalette[1],road:distinctPalette[6]};
let colorCache={}, availableColors=[...distinctPalette];
let chart; // global chart instance
let smoothLines = true; // default to smooth (curved) lines


/* ---------------- Color helpers ---------------- */
function resetColorSystem() {
  colorCache = {};
  availableColors = [...distinctPalette];
}

function getColorForGroup(name) {
  if (!name) return '#888888';
  if (colorCache[name]) return colorCache[name];

  const lower = name.toLowerCase();
  const cat = Object.keys(categoryBaseColor).find(c => lower.includes(c));

  // Prefer category colour if available
  let baseColor = cat ? categoryBaseColor[cat] : null;
  let chosenColor = baseColor;

  // Avoid duplicates: if base colour already used, pick next available
  if (!chosenColor || Object.values(colorCache).includes(chosenColor)) {
    chosenColor = availableColors.find(c => !Object.values(colorCache).includes(c));
  }

  // Fallback to any colour if palette exhausted (shouldn't happen with ‚â§10)
  if (!chosenColor) {
    chosenColor = distinctPalette[Object.keys(colorCache).length % distinctPalette.length];
  }

  colorCache[name] = chosenColor;
  return chosenColor;
}

/* ---------------- Data fetching ---------------- */
async function fetchGVizData(url){
  const res = await fetch(url);
  const txt = await res.text();
  if (!txt.includes('{')) throw new Error('Unexpected sheet response');
  // gviz returns something like: /*O_o*/ google.visualization.Query.setResponse({...});
  return JSON.parse(txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1));
}

async function loadUnits(){
  const j = await fetchGVizData(UNIT_SHEET_URL);
  if (!j.table || !j.table.rows) return;
  j.table.rows.forEach(r => {
    const cells = r.c.map(c => c ? c.v : null);
    if (cells[0] && cells[1]) pollutantUnits[cells[0]] = cells[1];
  });
}

async function loadData(){
  const j = await fetchGVizData(DATA_SHEET_URL);
  if (!j.table || !j.table.rows || !j.table.cols) throw new Error('Unexpected sheet structure');
  const headers = j.table.cols.map(c => c.label);
  const rows = j.table.rows.map(r => r.c.map(c => c ? c.v : null));
  globalHeaders = headers; globalRows = rows; groupedData = {};
  rows.forEach(row => {
    const group = row[0], pollutant = row[1];
    if (!group || !pollutant) return;
    if (!groupedData[pollutant]) groupedData[pollutant] = {};
    groupedData[pollutant][group] = row;
  });
}

/* ---------------- UI: selectors & group controls ---------------- */
function setupSelectors(){
  const pollutants = [...new Set(globalRows.map(r => r[1]).filter(Boolean))].sort();
  const sel = document.getElementById('pollutantSelect');
  sel.innerHTML = '<option value="">Select pollutant</option>';
  pollutants.forEach(p => sel.add(new Option(p, p)));

  const years = globalHeaders.slice(2).map(h => h ? h.replace(/^f/, '') : '');
  const s = document.getElementById('startYear'), e = document.getElementById('endYear');
  s.innerHTML = ''; e.innerHTML = '';
  years.forEach(y => { if(y) { s.add(new Option(y,y)); e.add(new Option(y,y)); } });
  s.value = years[0] || '';
  e.value = years[years.length-1] || '';

  sel.addEventListener('change', () => updateChart());
  s.addEventListener('change', () => updateChart());
  e.addEventListener('change', () => updateChart());
}

function getSelectedGroups(){ return [...document.querySelectorAll('#groupContainer select')].map(s => s.value).filter(Boolean); }

function addGroupSelector(defaultValue = "", usePlaceholder = true){
  const container = document.getElementById('groupContainer');
  const div = document.createElement('div');
  div.className = 'groupRow';
  div.draggable = true;

  // drag handle
  const dragHandle = document.createElement('span');
  dragHandle.className = 'dragHandle';
  dragHandle.textContent = '‚†ø';
  dragHandle.style.marginRight = '6px';
  div.appendChild(dragHandle);

  // group select
  const sel = document.createElement('select');
  if (usePlaceholder){
    const ph = new Option('Select group','');
    ph.disabled = true; ph.selected = true;
    sel.add(ph);
  }
  const allGroups = [...new Set(globalRows.map(r=>r[0]).filter(Boolean))].sort((a, b) => {
    // Move "All" to top, then alphabetical
    if (a.toLowerCase() === "all") return -1;
    if (b.toLowerCase() === "all") return 1;
    return a.localeCompare(b);
  });
 
  const selected = getSelectedGroups();
  allGroups.forEach(g => {
    if (!selected.includes(g) || g === defaultValue) sel.add(new Option(g,g));
  });
  if (defaultValue) sel.value = defaultValue;
  sel.addEventListener('change', () => { refreshGroupDropdowns(); updateChart(); });

  div.appendChild(sel);

  container.appendChild(div);
  addDragAndDropHandlers(div);
  refreshButtons();
}

function refreshGroupDropdowns(){
  const selected = getSelectedGroups();
  const all = [...new Set(globalRows.map(r=>r[0]).filter(Boolean))].sort((a, b) => {
    if (a.toLowerCase() === "all") return -1;
    if (b.toLowerCase() === "all") return 1;
    return a.localeCompare(b);
  });

  document.querySelectorAll('#groupContainer select').forEach(select => {
    const current = select.value;
    Array.from(select.options).forEach(opt => { if (opt.value !== '') opt.remove(); });
    all.forEach(g => {
      if (!selected.includes(g) || g === current) {
        const option = new Option(g,g);
        if (g === current) option.selected = true;
        select.add(option);
      }
    });
  });
}

function refreshButtons() {
  const container = document.getElementById('groupContainer');
  // Remove any existing Add/Remove buttons to rebuild cleanly
  container.querySelectorAll('.add-btn, .remove-btn').forEach(n => n.remove());

  const rows = container.querySelectorAll('.groupRow');

  // Add remove buttons only if there are 2 or more groups
  if (rows.length >= 2) {
    rows.forEach(row => {
      if (!row.querySelector('.remove-btn')) {
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '<span class="remove-icon">‚àí</span> Remove Group';
        removeBtn.onclick = () => {
          row.remove();
          refreshButtons();
          refreshGroupDropdowns();
          updateChart();
        };
        row.appendChild(removeBtn);
      }
    });
  }

  // Add "Add Group" button just below the last group box
  let addBtn = container.querySelector('.add-btn');
  if (!addBtn) {
    addBtn = document.createElement('button');
    addBtn.className = 'add-btn';
    addBtn.innerHTML = '<span class="add-icon">+</span> Add Group';
    addBtn.onclick = () => addGroupSelector("", true);
    container.appendChild(addBtn);
  }

  // Disable button if 10 groups are present
  if (rows.length >= 10) {
    addBtn.textContent = 'Max Groups = 10';
    addBtn.disabled = true;
  } else {
    addBtn.innerHTML = '<span class="add-icon">+</span> Add Group';
    addBtn.disabled = false;
  }
}

/* ---------------- Drag and drop handlers ---------------- */
function addDragAndDropHandlers(div){
  div.addEventListener('dragstart', e => {
    e.dataTransfer.setData('text/plain', '');
    div.classList.add('dragging');
  });
  div.addEventListener('dragend', () => div.classList.remove('dragging'));
  div.addEventListener('dragover', e => {
    e.preventDefault();
    const container = document.getElementById('groupContainer');
    const dragging = container.querySelector('.dragging');
    if (!dragging) return;
    const after = getDragAfterElement(container, e.clientY);
    const addBtn = container.querySelector('.add-btn');
    if (!after || after === addBtn) container.insertBefore(dragging, addBtn);
    else container.insertBefore(dragging, after);
  });
  div.addEventListener('drop', () => { refreshGroupDropdowns(); updateChart(); });
}

function getDragAfterElement(container, y){
  const draggable = [...container.querySelectorAll('.groupRow:not(.dragging)')];
  return draggable.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
    return closest;
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

/* ---------------- Chart rendering & legend ---------------- */
function updateChart(){
  const pollutant = document.getElementById('pollutantSelect').value;
  const startYear = +document.getElementById('startYear').value;
  const endYear = +document.getElementById('endYear').value;
  const groups = getSelectedGroups();
  if (!pollutant || !startYear || !endYear || !groups.length) return;

  resetColorSystem();
  const headers = globalHeaders;
  const startCol = headers.findIndex(h => h && h.toLowerCase() === `f${startYear}`);
  const endCol = headers.findIndex(h => h && h.toLowerCase() === `f${endYear}`);
  if (startCol === -1 || endCol === -1 || endCol < startCol) return;
  const years = headers.slice(startCol, endCol + 1).map(h => h.replace(/^f/, ''));
  const colors = groups.map(g => getColorForGroup(g));

  // Build rows of data (year + series values). Use null for missing.
  const chartRows = years.map((y, rowIdx) => {
    const row = [y];
    groups.forEach(g => {
      const dataRow = groupedData[pollutant]?.[g];
      const raw = dataRow ? dataRow[startCol + rowIdx] : null;
      const val = (raw === null || raw === undefined) ? null : parseFloat(raw);
      row.push(Number.isNaN(val) ? null : val);
    });
    return row;
  });

  // guard against empty data
  if (chartRows.length === 0) return;

  // --- Determine which groups actually have data ---
  const groupHasData = groups.map((g, i) => {
    return chartRows.some(row => typeof row[i + 1] === 'number');
  });

  // Create DataTable explicitly to guarantee column types
  const dataTable = new google.visualization.DataTable();
  dataTable.addColumn('string', 'Year');           // year as string
  groups.forEach(g => dataTable.addColumn('number', g)); // explicit numeric series columns
  dataTable.addRows(chartRows);

  const unit = pollutantUnits[pollutant] || "";
  const seriesOptions = {};
  groups.forEach((g, i) => {
    seriesOptions[i] = { color: colors[i], lineWidth: 3, pointSize: 4 };
  });

  // Estimate left margin dynamically based on Y-axis label width
  const maxValue = Math.max(
    ...chartRows.flatMap(r => r.slice(1).filter(v => typeof v === "number"))
  );
  const labelLength = maxValue ? maxValue.toLocaleString().length : 3;
  const leftMargin = Math.min(100, Math.max(60, labelLength * 10)); // dynamic left padding

  const options = {
    title: '',
    width: '100%',
    height: '70%',
    legend: 'none',
    hAxis: { title: 'Year' },
    vAxis: {
      title: `Emissions${unit ? " (" + unit + ")" : ""}`,
      viewWindow: { min: 0 },
      textStyle: { fontSize: 12 },
      titleTextStyle: { fontSize: 13, bold: true }
    },
    series: seriesOptions,
    curveType: smoothLines ? 'function' : 'none',
    lineWidth: 3,
    pointSize: 4,
    chartArea: {
      top: 20,
      left: leftMargin,
      right: 20,
      bottom: 60,
      width: '85%',
      height: '70%'
    }
  };

 

  // draw chart and show pollutant as visible page title
  chart = new google.visualization.LineChart(document.getElementById('chart_div'));
  chart.draw(dataTable, options);
  document.getElementById('chart_div').classList.add('visible');



  // update visible title on page
  const titleEl = document.getElementById('chartTitle');
  titleEl.textContent = `${pollutant}${unit ? " (" + unit + ")" : ""}`;

  // build custom legend (interactive)
  const legendDiv = document.getElementById('customLegend');
  legendDiv.innerHTML = '';
  const seriesVisibility = Array(groups.length).fill(true);

  groups.forEach((g, i) => {
    const item = document.createElement('span');
    const dot = document.createElement('span');
    dot.style.display = 'inline-block';
    dot.style.width = '12px';
    dot.style.height = '12px';
    dot.style.borderRadius = '50%';
    dot.style.backgroundColor = colors[i];
    item.appendChild(dot);

    const labelText = document.createTextNode(g + (groupHasData[i] ? '' : ' (No data available)'));
    item.appendChild(labelText);

    // Fade if no data
    if (!groupHasData[i]) {
      item.style.opacity = '0.4';
      item.title = 'No data available';
    }

    // Toggle visibility only if data exists
    if (groupHasData[i]) {
      item.addEventListener('click', () => {
        seriesVisibility[i] = !seriesVisibility[i];
        const newOptions = { ...options, series: {} };
        groups.forEach((g2, idx) => {
          newOptions.series[idx] = seriesVisibility[idx]
            ? { color: colors[idx], lineWidth: 3, pointSize: 4 }
            : { color: colors[idx], lineWidth: 0, pointSize: 0 };
        });
        chart.draw(dataTable, newOptions);
        item.style.opacity = seriesVisibility[i] ? '1' : '0.4';
      });
    }

    legendDiv.appendChild(item);
  });

  // ensure controls reflect available choices
  refreshGroupDropdowns();
  refreshButtons();
}

window.addEventListener('resize', () => {
  clearTimeout(window._resizeTimer);
  window._resizeTimer = setTimeout(updateChart, 200);
});

function setupDownloadButton() {
  const dl = document.getElementById('downloadBtn');

  dl.addEventListener('click', () => {
    const pollutant = document.getElementById('pollutantSelect').value;
    if (!chart || !pollutant) return;

    const unit = pollutantUnits[pollutant] || "";
    const imageURI = chart.getImageURI();
    const img = new Image();
    img.crossOrigin = 'anonymous';

    img.onload = () => {
      // --- Measure legend for layout ---
      const legendClone = document.getElementById('customLegend').cloneNode(true);
      legendClone.style.position = 'absolute';
      legendClone.style.visibility = 'hidden';
      legendClone.style.width = Math.min(800, img.width) + 'px';
      document.body.appendChild(legendClone);
      const legendHeight = legendClone.offsetHeight + 10;
      document.body.removeChild(legendClone);

      const titleHeight = 30;
      const footerHeight = 40;
      const padding = 20;

      // --- Determine output size ---
      const unscaledWidth = img.width + padding * 2;
      const unscaledHeight =
        img.height + titleHeight + legendHeight + footerHeight + padding * 3;

      // --- Auto-scale for print quality ---
      // For A4 landscape at 300 DPI: 3508 px wide
      const targetWidth = 3508;
      const scale = Math.max(
        window.devicePixelRatio || 1,
        targetWidth / unscaledWidth
      );

      const canvas = document.createElement('canvas');
      canvas.width = unscaledWidth * scale;
      canvas.height = unscaledHeight * scale;
      const ctx = canvas.getContext('2d');
      ctx.scale(scale, scale);

      // --- Background ---
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, unscaledWidth, unscaledHeight);

      // --- Title ---
      ctx.font = 'bold 18px system-ui, sans-serif';
      ctx.fillStyle = '#000000';
      ctx.textAlign = 'center';
      ctx.fillText(
        `${pollutant}${unit ? " (" + unit + ")" : ""}`,
        unscaledWidth / 2,
        padding + 15
      );

      // --- Legend ---
      const legendDiv = document.getElementById('customLegend');
      const items = [...legendDiv.querySelectorAll('span')];
      let legendY = padding + 35;
      const legendRowHeight = 22;
      const maxW = unscaledWidth - padding * 2;
      const rowItems = [];
      let row = [],
        rowW = 0;

      items.forEach((it) => {
        const dot = it.querySelector('span');
        if (!dot) return;
        const text = it.textContent.trim();
        ctx.font = '600 14px system-ui, sans-serif';
        const textW = ctx.measureText(text).width;
        const w = textW + 40;
        if (rowW + w > maxW && row.length) {
          rowItems.push({ row, rowW });
          row = [];
          rowW = 0;
        }
        row.push({ dotColor: dot.style.backgroundColor, text });
        rowW += w;
      });

      if (row.length) rowItems.push({ row, rowW });

      rowItems.forEach(({ row, rowW }) => {
        let x = (unscaledWidth - rowW) / 2;
		row.forEach(({ dotColor, text }) => {
		  const faded = text.includes('(No data available)');
		  ctx.globalAlpha = faded ? 0.4 : 1.0;
		  ctx.beginPath();
		  ctx.arc(x + 6, legendY - 5, 6, 0, 2 * Math.PI);
		  ctx.fillStyle = dotColor;
		  ctx.fill();
		  ctx.font = '600 14px system-ui, sans-serif';
		  ctx.fillStyle = '#000000';
		  ctx.textAlign = 'left';
		  ctx.fillText(text, x + 18, legendY);
		  ctx.globalAlpha = 1.0;
		  x += ctx.measureText(text).width + 40;
		});
        legendY += legendRowHeight;
      });

      // --- Chart image ---
      ctx.drawImage(img, padding, legendY + 10);

      // --- Logo and footer ---
      const logo = new Image();
      logo.crossOrigin = 'anonymous'; // Allow CORS for canvas export
      logo.src = 'CIC - Square - Border - Words - Alpha 360x360.png';

      const finishExport = () => {
        const footerText =
          "¬© Crown 2025 copyright Defra & DESNZ via naei.energysecurity.gov.uk licensed under the Open Government Licence (OGL).";
        const timestamp = new Date().toISOString().replace("T", " ").substring(0, 19);

        ctx.font = '12px system-ui, sans-serif';
        ctx.fillStyle = '#555';
        ctx.textAlign = 'center';
        ctx.fillText(footerText, unscaledWidth / 2, legendY + img.height + 20);

        // --- Download ---
        const link = document.createElement('a');
        const safeName = pollutant.replace(/[^a-z0-9_\-]/gi, '_');
        link.download = `${safeName}_comparison.png`;
        link.href = canvas.toDataURL('image/png');
        document.body.appendChild(link);
        link.click();
        link.remove();
      };

      logo.onload = () => {
        try {
          const logoSize = 80;
          ctx.drawImage(logo, unscaledWidth - logoSize - 20, 10, logoSize, logoSize);
          finishExport();
        } catch (e) {
          console.warn('Logo failed to draw, continuing without logo:', e);
          finishExport();
        }
      };

      logo.onerror = () => {
        console.warn('Logo failed to load, continuing without logo');
        finishExport();
      };
    };

    img.onerror = (e) => {
      console.error('Failed to load chart image for export', e);
      alert('Sorry ‚Äî failed to generate the PNG from the chart image.');
    };

    img.src = imageURI;
  });
}
/* ---------------- Initialization ---------------- */
async function init(){
  try {
    await loadUnits();
    await loadData();
  } catch (err) {
    console.error('Failed loading data:', err);
    document.getElementById('loadingOverlay').innerHTML = '<div style="color:#900;font-weight:700">Failed to load data ‚Äî check sheet access.</div>';
    return;
  }

  setupSelectors();

  // add one default group selector: prefer the first available group, otherwise placeholder
  const firstGroup = globalRows.length ? globalRows[0][0] : '';
  if (firstGroup) addGroupSelector(firstGroup, false);
  else addGroupSelector('', true);

  setupDownloadButton();
  setupSmoothingToggle();
  
  document.getElementById('downloadCSVBtn').addEventListener('click', () => exportData('csv'));
  document.getElementById('downloadXLSXBtn').addEventListener('click', () => exportData('xlsx'));

  // default pollutant (if exists)
  const sel = document.getElementById('pollutantSelect');
  if (sel.querySelector('option[value="PM2.5"]')) sel.value = 'PM2.5';

  // show UI
  const overlay = document.getElementById('loadingOverlay'), content = document.getElementById('mainContent');
  overlay.style.opacity = '0';
  setTimeout(() => {
    overlay.style.display = 'none';
    content.style.display = 'block';
    setTimeout(() => { content.classList.add('loaded'); setTimeout(()=>updateChart(), 200); }, 50);
  }, 400);
}
function setupSmoothingToggle() {
  const btn = document.getElementById('toggleSmoothBtn');
  btn.addEventListener('click', () => {
    smoothLines = !smoothLines;
    btn.textContent = smoothLines ? 'üö´ Disable Smoothing' : '‚úÖ Enable Smoothing';
    updateChart();
  });
}

function exportData(format = 'csv') {
  const pollutant = document.getElementById('pollutantSelect').value;
  const startYear = +document.getElementById('startYear').value;
  const endYear = +document.getElementById('endYear').value;
  const selectedGroups = getSelectedGroups();
  if (!pollutant || !selectedGroups.length || !globalHeaders.length) {
    alert('Please select a pollutant and at least one group first.');
    return;
  }

  // Find columns for selected years
  const startCol = globalHeaders.findIndex(h => h && h.toLowerCase() === `f${startYear}`);
  const endCol = globalHeaders.findIndex(h => h && h.toLowerCase() === `f${endYear}`);
  if (startCol === -1 || endCol === -1 || endCol < startCol) {
    alert('Invalid year range.');
    return;
  }

  const years = globalHeaders.slice(startCol, endCol + 1).map(h => h.replace(/^f/, ''));
  const unit = pollutantUnits[pollutant] || '';

  // --- Build rows ---
  const rows = [];
  const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 16);

  // First row: pollutant and unit
  rows.push([`Pollutant: ${pollutant}`, `Unit: ${unit}`]);
  rows.push([]); // spacer row
  // Header row
  rows.push(['Group', ...years]);

  // Data rows
  selectedGroups.forEach(group => {
    const dataRow = groupedData[pollutant]?.[group];
    const values = years.map((y, idx) => {
      const raw = dataRow ? dataRow[startCol + idx] : null;
      return raw ?? '';
    });
    rows.push([group, ...values]);
  });

  rows.push([]); // spacer
  rows.push([`Downloaded on: ${timestamp}`]);

  // --- Generate and download file ---
  const safePollutant = pollutant.replace(/[^a-z0-9_\-]/gi, '_');
  if (format === 'csv') {
    const csvContent = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${safePollutant}_data.csv`;
    link.click();
  } else if (format === 'xlsx') {
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'Data');
    XLSX.writeFile(wb, `${safePollutant}_data.xlsx`);
  }
}
async function loadGroupInfo() {
  const NFRCODE_SHEET_URL =
    'https://docs.google.com/spreadsheets/d/1m0as8iV7quPhM5fg_8fJpzAEQh_LBBDFwnuzf71QJZM/gviz/tq?sheet=NFRCodes&tq=SELECT%20*';

  try {
    const nfrRes = await fetch(NFRCODE_SHEET_URL);
    const nfrTxt = await nfrRes.text();

   // console.log("NFRCodes raw gviz response:", nfrTxt.slice(0, 500));

    const jsonStart = nfrTxt.indexOf('{');
    const jsonEnd = nfrTxt.lastIndexOf('}');
    const nfrJson = JSON.parse(nfrTxt.substring(jsonStart, jsonEnd + 1));

    const nfrMap = {};

    if (nfrJson.table && nfrJson.table.rows && nfrJson.table.rows.length > 1) {
      const firstRow = nfrJson.table.rows[0].c.map(c => c?.v?.toString().trim().toLowerCase());
      console.log('Detected NFRCodes header row:', firstRow);

      const codeIdx = firstRow.findIndex(c => c.includes('nfr_code'));
      const descIdx = firstRow.findIndex(c => c.includes('desc'));
      const dataRows = nfrJson.table.rows.slice(1);

      dataRows.forEach(r => {
        if (!r.c) return;
        const codeCell = r.c[codeIdx];
        const descCell = r.c[descIdx];
        if (!codeCell || !descCell) return;

        const code = codeCell.v?.toString().trim().replace(/\s+/g, '').toUpperCase();
        const desc = descCell.v?.toString().trim();
        if (code && desc) nfrMap[code] = desc;
      });
    }

    const response = await fetch('Groups-NAEI_mulitgroup_viewer.csv?cacheBust=' + Date.now());
    if (!response.ok) throw new Error('Failed to fetch CSV file');
    const text = await response.text();
    const lines = text.trim().split(/\r?\n/);
    const headers = lines.shift().split(',').map(h => h.trim().toLowerCase());

    const titleIdx = headers.findIndex(h => h.includes('group_title'));
    const sourceIdx = headers.findIndex(h => h.includes('source'));
    const activityIdx = headers.findIndex(h => h.includes('activity'));
    const nfrIdx = headers.findIndex(h => h.includes('nfrcode'));

    const groups = lines.map(line => {
      const cells = line.split(',').map(c => c.trim());
      const nfrCodes = nfrIdx !== -1
        ? (cells[nfrIdx] || "").split(';').map(n => n.trim()).filter(Boolean)
        : [];

      const nfrDescriptions = nfrCodes.map(code => {
        const lookupKey = code.toString().trim().replace(/\s+/g, '').toUpperCase();
        const desc = nfrMap[lookupKey] || "(Description not found)";
        return { code, desc };
      });

      return {
        name: cells[titleIdx] || "",
        sources: (cells[sourceIdx] || "").split(';').map(s => s.trim()).filter(Boolean),
        activities: (cells[activityIdx] || "").split(';').map(a => a.trim()).filter(Boolean),
        nfrDescriptions
      };
    }).filter(g => g.name);

    groups.sort((a, b) => {
      if (a.name.toLowerCase() === "all") return -1;
      if (b.name.toLowerCase() === "all") return 1;
      return a.name.localeCompare(b.name);
    });

    // --- Build HTML output ---
    let html = `
      <table id="groupTable" style="border-collapse:collapse;width:100%;font-family:inherit;font-size:14px;color:#000;">
        <thead>
          <tr style="background:#d0d0d0;">
            <th style="border:1px solid #444;padding:8px;text-align:left;vertical-align:top;width:25%;">Group Name</th>
            <th style="border:1px solid #444;padding:8px;text-align:left;vertical-align:top;width:40%;">Sources</th>
            <th style="border:1px solid #444;padding:8px;text-align:left;vertical-align:top;width:35%;">Fuel Types (Activity in NAEI data)</th>
          </tr>
        </thead>
        <tbody>
    `;

    groups.forEach(g => {
      let sourcesHTML = "";

      if (g.nfrDescriptions.length) {
        sourcesHTML += `<span style="text-decoration:underline;font-weight:600;display:block;margin-bottom:4px;">All Sources from the following NFR Code categories:</span>`;
        // üëá Removed monospace ‚Äî inherits normal page font
        sourcesHTML += `<div style="white-space:pre-line;">`;
        g.nfrDescriptions.forEach(n => {
          sourcesHTML += `${n.code}\t${n.desc}\n`;
        });
        sourcesHTML += `</div>`;
      } else {
        sourcesHTML = g.sources.length ? g.sources.join('\n') : 'All Sources';
      }

      const activitiesText = g.activities.length ? g.activities.join('\n') : 'All Fuel Types';

      html += `
        <tr style="border:1px solid #444;">
          <td style="border:1px solid #444;padding:8px;white-space:pre-line;font-family:inherit;">${g.name}</td>
          <td style="border:1px solid #444;padding:8px;white-space:pre-line;font-family:inherit;">${sourcesHTML}</td>
          <td style="border:1px solid #444;padding:8px;white-space:pre-line;font-family:inherit;">${activitiesText}</td>
        </tr>
      `;
    });

    html += "</tbody></table>";

    const container = document.getElementById('group-info');

    // ‚úÖ Ensure container matches the main page font
    container.style.fontFamily = 'system-ui, sans-serif';
    container.style.fontSize = '14px';
    container.style.color = '#000';

    container.innerHTML = html;

  } catch (err) {
    console.error("Error loading group info:", err);
    document.getElementById('group-info').innerHTML =
      "<p class='text-red-600'>‚ö†Ô∏è Could not load group or NFRCodes information.</p>";
  }
}
document.addEventListener('DOMContentLoaded', loadGroupInfo);

document.addEventListener('DOMContentLoaded', () => google.charts.setOnLoadCallback(init));
</script>
</body>
</html>
