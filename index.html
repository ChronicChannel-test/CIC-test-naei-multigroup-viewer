<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UK Air Pollution and Emissions Data Explorer</title>
  <link rel="icon" type="image/png" sizes="64x64" href="SharedResources/images/favicon.png">
  <link rel="apple-touch-icon" href="SharedResources/images/favicon.png">

  <!-- Social preview / link preview meta tags -->
  <meta name="description" content="Interactive charts using UK Government data"> 
  <!-- Open Graph (Facebook, LinkedIn, Slack, etc.) -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="UK Air Pollution and Emissions Data Explorer">
  <meta property="og:description" content="Interactive charts using UK Government data">
  <meta property="og:url" content="https://github.com/Chronic-Illness-Channel/naei-multigroup-viewer">
  <meta property="og:image" content="SharedResources/images/CIC%20-%20NAEI%20Multi-Group%20Viewer%20Thumbnail.1120x630.png">
  <meta property="og:image:width" content="1120">
  <meta property="og:image:height" content="630">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="UK Air Pollution and Emissions Data Explorer">
  <meta name="twitter:description" content="Interactive charts using UK Government data">
  <meta name="twitter:image" content="SharedResources/images/CIC%20-%20NAEI%20Multi-Group%20Viewer%20Thumbnail.1120x630.png">
  <meta name="twitter:site" content="@Chronic_Channel">
  <meta name="twitter:creator" content="@Chronic_Channel">

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- Load Supabase and shared resources -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="SharedResources/supabase-config.js"></script>
  <!-- Shared Data Loader -->
  <script src="SharedResources/shared-data-loader.js"></script>
  
  <!-- Google Charts for charting -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  
  <!-- XLSX for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="dist/tailwind.css">
  <style>
    /* Chart interface - no transition needed, overlay fade handles visibility */
    
    /* Chart containers render immediately; parent overlay handles fade */
    .chart-container {
      opacity: 1;
      transition: none;
      padding: 0;
    }
    
    .chart-container.ready {
      opacity: 1;
    }
    
    /* Full-screen loading overlay */
    #main-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: white;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease;
    }
    
    #main-loading-overlay .main-spinner {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: conic-gradient(#E6194B 0deg 120deg, #F58231 120deg 240deg, #FFE119 240deg 360deg);
      animation: spin 1.25s linear infinite;
      margin-bottom: 20px;
    }
    
    #main-loading-overlay .main-loading-text {
      color: #374151;
      font-size: 18px;
      font-weight: 500;
    }
    
  #chart_div {
      width: 100%;
      min-height: 400px;
    }
    
    .spinner {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background: conic-gradient(#E6194B 0deg 120deg, #F58231 120deg 240deg, #FFE119 240deg 360deg);
      animation: spin 1.25s linear infinite;
      box-shadow: 0 0 12px rgba(0,0,0,0.08);
      outline: none;
      border: none;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Sidebar Social Media Styles (from chart v2.4) */
    #cicLogo {
      width: 110px;
      height: auto;
      display: block;
    }

    .sidebar-socials {
      position: fixed;
      top: 16px;
      right: 16px;
      width: 110px;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 100;
    }

    .sidebar-icons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
    }

    .sidebar-link {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
    }

    .sidebar-link img {
      display: block;
      height: 40px;
      width: 40px;
      object-fit: contain;
    }

    .tab-active {
      color: #FF9301;
      border-bottom-color: #FF9301;
    }

    .tab-active:hover {
      color: #FF9301;
      border-bottom-color: #FF9301;
    }

    /* Brand link styling */
    :root {
      --brand-link-color: #FF9301;
      --brand-link-hover: #cc7500;
    }

    a[href]:not(.kofi-button),
    a[href]:not(.kofi-button):visited {
      color: var(--brand-link-color);
      transition: color 0.2s ease-in-out;
    }

    a[href]:not(.kofi-button):hover,
    a[href]:not(.kofi-button):focus-visible,
    a[href]:not(.kofi-button):active {
      color: var(--brand-link-hover);
    }

    .kofi-button,
    .kofi-button:visited,
    .kofi-button:hover,
    .kofi-button:focus-visible {
      color: #ffffff;
    }

    .kofi-button .kofi-text {
      color: inherit;
    }

    a[href*="facebook.com"] img {
      width: 36px;
      height: 36px;
    }

    .kofi-wrapper {
      width: 40px;
      height: 40px;
      position: relative;
      margin-top: 13px;
    }

    .kofi-button {
      display: flex;
      flex-direction: row-reverse;
      align-items: center;
      background-color: #ff9301;
      border-radius: 8px;
      height: 40px;
      color: white;
      text-decoration: none;
      overflow: hidden;
      position: absolute;
      top: 0;
      right: 0;
      width: 40px;
      transition: width 0.4s ease-in-out;
    }

    .kofi-wrapper:hover .kofi-button {
      width: 295px;
    }

    .kofi-icon-svg {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 40px;
      min-width: 40px;
      flex-shrink: 0;
    }

    .kofi-text {
      white-space: nowrap;
      padding-right: 0px;
      padding-left: 0px; 
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.3s ease-in-out 0.1s;
    }

    .kofi-wrapper:hover .kofi-text {
      opacity: 1;
    }

    .opera-browser .kofi-wrapper:hover .kofi-button {
      width: 295px;
    }

    @supports (-webkit-appearance: none) {
      .kofi-button .kofi-text {
        font-size: 16px;
      }
    }
    
    /* Mobile responsive styles */
    @media (max-width: 620px) {
      .sidebar-socials {
        position: static;
        width: 100%;
        flex-direction: row;
        align-items: flex-start;
        margin: 16px 20px;
        gap: 12px;
        top: auto;
        right: auto;
      }

      #cicLogo {
        width: 90px;
      }

      .sidebar-icons {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 8px;
        margin-top: 0;
        width: auto;
      }
      
      .kofi-wrapper {
        margin-top: 0;
        margin-left: 0px;
        align-self: flex-start;
        width: 35px;
        height: 35px;
      }
      
      .kofi-button, .kofi-icon-svg {
        height: 35px;
      }
      
      .kofi-button {
        width: 35px;
        transition: none;
      }
      
      .kofi-wrapper:hover .kofi-button {
        width: 35px;
      }
      
      .kofi-wrapper:hover .kofi-text {
        opacity: 0;
      }
    
      .kofi-button img {
        position: relative;
        transform: translateX(3px);
      }

      .sidebar-link {
        width: 35px;
        height: 35px;
        margin-bottom: 0;
      }

      .sidebar-link img {
        width: 35px;
        height: 35px;
      }

      a[href*="facebook.com"] img {
        width: 32px;
        height: 32px;
      }
    }

    .remove-group-btn,
    .add-group-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      margin: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }

    .remove-group-btn img,
    .add-group-btn img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .group-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
    }

    .group-info img {
      width: 24px;
      height: 24px;
    }

    html,
    body {
      height: 100%;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .page-stack {
      flex: 1 0 auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    #chart-interface {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #chart-interface > footer {
      margin-top: auto;
    }
  </style>
</head>

<body>

  <!-- Full-screen loading overlay -->
  <div id="main-loading-overlay">
    <div class="main-spinner"></div>
    <div class="main-loading-text">Loading data, please wait...</div>
  </div>

  <!-- CIC Logo and Social Media Sidebar -->
  <div class="sidebar-socials">
    <a href="https://chronic-illness-channel.github.io" target="_blank">
      <img id="cicLogo" src="SharedResources/images/CIC-Square-Border-Words-Alpha.svg" alt="CIC Logo">
    </a>
    <div class="sidebar-icons">
      <a href="https://youtube.com/@chronichannelillness" target="_blank" class="sidebar-link">
        <img src="SharedResources/images/youtube-logo-6.svg" alt="YouTube">
      </a>
      <a href="https://bsky.app/profile/chronicillnesschannel.bsky.social" target="_blank" class="sidebar-link">
        <img src="SharedResources/images/Bluesky_Logo.svg" alt="Bluesky">
      </a>
      <a href="https://twitter.com/chronic_channel" target="_blank" class="sidebar-link">
        <img src="SharedResources/images/Twitter-dead-bird-X-220x206.svg" alt="Twitter/X">
      </a>
      <a href="https://facebook.com/chronicillnesschannel" target="_blank" class="sidebar-link">
        <img src="SharedResources/images/facebook.svg" alt="Facebook">
      </a>
    </div>
    <div class="kofi-wrapper">
      <a href="https://ko-fi.com/chronicillnesschannel" target="_blank" class="kofi-button">
        <span class="kofi-icon-svg">
          <img src="SharedResources/images/kofi_symbol.svg" alt="Ko-fi" style="width: 28px; height: 28px; display: block; object-fit: contain;">
        </span>
        <span class="kofi-text">Support Chronic Illness Channel</span>
      </a>
    </div>
  </div>

  <div class="page-stack">
  <!-- Header -->
  <div class="bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center">
          <div>
            <h1 class="text-3xl font-bold text-gray-900">UK Air Pollution and Emissions Data Explorer</h1>
            <p class="text-sm text-gray-500">Interactive Charts using UK Government Data</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="chart-interface" style="opacity: 0; margin: 0;">
    <!-- Tab Navigation -->
    <div class="bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="border-b border-gray-200">
          <nav class="-mb-px flex flex-wrap items-center gap-6" role="tablist" aria-label="Chart views">
            <button type="button" id="tab-1" data-chart="1" onclick="switchChart('1')" role="tab" aria-controls="chart-1" aria-selected="true" tabindex="0" class="py-4 px-2 border-b-2 font-semibold text-[21px] transition-colors flex items-center gap-2">
              <img src="SharedResources/images/Bubble-Chart-Icon4.png" alt="Bubble chart icon" class="w-auto" style="height: 37px;">
              <span>Bubble Chart</span>
            </button>
            <button type="button" id="tab-2" data-chart="2" onclick="switchChart('2')" role="tab" aria-controls="chart-2" aria-selected="false" tabindex="-1" class="py-4 px-2 border-b-2 font-semibold text-[21px] transition-colors flex items-center gap-2">
              <img src="SharedResources/images/Line-Chart-Icon7.png" alt="Line chart icon" class="w-auto" style="height: 37px;">
              <span>Line Chart</span>
            </button>
            <button type="button" id="tab-group-info" data-chart="group-info" onclick="switchChart('group-info')" role="tab" aria-controls="chart-group-info" aria-selected="false" tabindex="-1" class="py-4 px-2 border-b-2 font-semibold text-[21px] transition-colors flex items-center gap-2">
              <img src="SharedResources/images/Group-Info-Icon.png" alt="Group info icon" class="h-8 w-auto" style="height: 37px;">
              <span>Group Info</span>
            </button>
            <button type="button" id="tab-user-guide" data-chart="user-guide" onclick="switchChart('user-guide')" role="tab" aria-controls="chart-user-guide" aria-selected="false" tabindex="-1" class="py-4 px-2 border-b-2 font-semibold text-[21px] transition-colors flex items-center gap-2">
              <img src="SharedResources/images/instructions-alpha-v4.png" alt="User guide icon" class="w-auto" style="height: 37px;">
              <span>User Guide</span>
            </button>
            <button type="button" id="tab-resources" data-chart="resources" onclick="switchChart('resources')" role="tab" aria-controls="chart-resources" aria-selected="false" tabindex="-1" class="py-4 px-2 border-b-2 font-semibold text-[21px] transition-colors flex items-center gap-2">
              <img src="SharedResources/images/chain-link-icon-CIC.png" alt="Resources icon" class="h-8 w-auto" style="height: 37px;">
              <span>Resources</span>
            </button>
          </nav>
        </div>
      </div>
    </div>

    <!-- Bubble Chart Container -->
  <div id="chart-1" class="chart-container" role="tabpanel" aria-labelledby="tab-1" aria-hidden="false">
      <iframe
        id="bubblechart-iframe"
        class="chart-iframe"
        src="CIC-test-naei-bubblechart-v2.0/index.html"
        frameborder="0"
        scrolling="no"
        style="height: 600px;"
        title="NAEI Activity Data Bubble Chart"></iframe>
    </div>

    <!-- Line Chart Container -->
  <div id="chart-2" class="chart-container" style="visibility: hidden; height: 0; overflow: hidden;" role="tabpanel" aria-labelledby="tab-2" aria-hidden="true">
      <iframe
        id="linechart-iframe"
        class="chart-iframe"
        src="CIC-test-naei-linechart-v2.4/index.html"
        frameborder="0"
        scrolling="no"
        style="height: 600px;"
        title="NAEI Activity Data Line Chart"></iframe>
    </div>

    <!-- Group Info Container -->
  <div id="chart-group-info" class="chart-container" style="visibility: hidden; height: 0; overflow: hidden;" role="tabpanel" aria-labelledby="tab-group-info" aria-hidden="true">
      <iframe
        id="groupinfo-iframe"
        class="chart-iframe"
        src="group-info-embed.html"
        frameborder="0"
        scrolling="no"
        style="height: 900px;"
        title="NAEI Group Information"></iframe>
    </div>

    <!-- User Guide Container -->
  <div id="chart-user-guide" class="chart-container" style="visibility: hidden; height: 0; overflow: hidden;" role="tabpanel" aria-labelledby="tab-user-guide" aria-hidden="true">
      <iframe
        id="userguide-iframe"
        class="chart-iframe"
        src="user-guide-embed.html"
        frameborder="0"
        scrolling="no"
        style="height: 900px;"
        title="NAEI User Guide"></iframe>
    </div>

    <!-- Resources Container -->
  <div id="chart-resources" class="chart-container" style="visibility: hidden; height: 0; overflow: hidden;" role="tabpanel" aria-labelledby="tab-resources" aria-hidden="true">
      <iframe
        id="resources-iframe"
        class="chart-iframe"
        src="resources-embed.html"
        frameborder="0"
        scrolling="no"
        style="height: 900px;"
        title="NAEI Resources"></iframe>
    </div>

    <!-- Footer (inside chart-interface so it fades in with the chart) -->
  <footer class="bg-gray-50 border-t border-gray-200 py-1 px-4 text-center text-sm text-gray-700" id="mainFooter" style="margin-top: 0; opacity: 1;">
      <span class="footer-copyright">¬© Crown 2025 copyright Defra &amp; DESNZ via
      <a href="https://naei.energysecurity.gov.uk" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800">naei.energysecurity.gov.uk</a></span>
      <span class="footer-license">licensed under the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800">Open Government Licence (OGL)</a>.</span>
      <br>
      <strong>YouTube:</strong> <a href="https://www.youtube.com/@ChronicIllnessChannel" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800">www.youtube.com/@ChronicIllnessChannel</a>
      <br>
      <span style="font-size: 0.8em; color: #666; margin-top: 4px; display: inline-block;">
        Explorer Version: v3.0 CIC-testdb (Line: v2.4, Bubble: v2.0) ‚Ä¢ Build: 2025.11.18
      </span>
    </footer>
  </div> <!-- End chart-interface -->
  </div> <!-- End page-stack -->

  <style>
    .chart-iframe {
      width: 100%;
      max-width: 100%;
      border: none;
      background: white;
      display: block;
      overflow: hidden;
    }

    .footer-copyright,
    .footer-license {
      white-space: nowrap;
    }
    
    @media (max-width: 900px) {
      .footer-copyright {
        display: block;
      }
    }
  </style>

  <script>
    (function() {
      var redirect = sessionStorage.redirect;
      delete sessionStorage.redirect;
      if (redirect && redirect != location.href) {
        history.replaceState(null, null, redirect);
      }
    })();

    // Chart routing system with tabbed interface
    let currentChart = null;
    const globalUrlParams = new URLSearchParams(window.location.search || '');
    const debugLoggingEnabled = ['debug', 'logs', 'debugLogs'].some(flag => globalUrlParams.has(flag));
    const debugWarn = (...args) => {
      if (debugLoggingEnabled) {
        console.warn(...args);
      }
    };
    window.__NAEI_DEBUG__ = debugLoggingEnabled;

    if (!debugLoggingEnabled) {
      console.log = () => {};
      console.info = () => {};
      if (console.debug) {
        console.debug = () => {};
      }
    }
    
    const STATIC_CHART_IDS = new Set(['group-info', 'user-guide', 'resources']);
    const CHART_SEQUENCE = ['1', '2', 'group-info', 'user-guide', 'resources'];
    const TAB_ID_MAP = {
      '1': 'tab-1',
      '2': 'tab-2',
      'group-info': 'tab-group-info',
      'user-guide': 'tab-user-guide',
      'resources': 'tab-resources'
    };

    // Store last known state for each chart (populated by messages from iframes)
    const chartStates = {
      '1': [],            // Bubble chart state
      '2': [],            // Line chart state
      'group-info': [],   // Group info view (static)
      'user-guide': [],   // User guide view (static)
      'resources': []     // Resources view (static)
    };

    const bubbleTutorialParamPresent = ['bubbletutorial', 'bubbleTutorial'].some(param => globalUrlParams.has(param));
    const bubbleTutorialControl = {
      requested: bubbleTutorialParamPresent,
      active: bubbleTutorialParamPresent,
      openRequestSent: false
    };
    
    // Load shared resources
    window.addEventListener('DOMContentLoaded', function() {
      // Load shared analytics, colors, and configuration
      loadScript('SharedResources/analytics.js');
      loadScript('SharedResources/colors.js');
    });
    
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    const chartReadyState = {
      bubble: false,
      line: false
    };

    const iframeElements = {
      bubble: document.getElementById('bubblechart-iframe'),
      line: document.getElementById('linechart-iframe'),
      'group-info': document.getElementById('groupinfo-iframe'),
      'user-guide': document.getElementById('userguide-iframe'),
      resources: document.getElementById('resources-iframe')
    };

    function decomposeUrl(rawUrl) {
      if (typeof rawUrl !== 'string' || !rawUrl.length) {
        return { origin: '', base: '', query: '', hash: '' };
      }

      let working = rawUrl;
      let origin = '';

      const absoluteUrlPattern = /^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//;
      if (absoluteUrlPattern.test(rawUrl)) {
        try {
          const parsed = new URL(rawUrl);
          origin = `${parsed.protocol}//${parsed.host}`;
          working = parsed.pathname + parsed.search + parsed.hash;
        } catch (error) {
          debugWarn('Unable to parse absolute URL:', error);
        }
      }

      const hashIndex = working.indexOf('#');
      const hash = hashIndex >= 0 ? working.slice(hashIndex) : '';
      const withoutHash = hashIndex >= 0 ? working.slice(0, hashIndex) : working;

      const queryIndex = withoutHash.indexOf('?');
      const base = queryIndex >= 0 ? withoutHash.slice(0, queryIndex) : withoutHash;
      const query = queryIndex >= 0 ? withoutHash.slice(queryIndex + 1) : '';

      return { origin, base, query, hash };
    }

    function rebuildUrl({ origin = '', base = '', query = '', hash = '' }) {
      const queryPart = query ? `?${query}` : '';
      return `${origin}${base}${queryPart}${hash}`;
    }

    function applyBubbleTutorialFlag(url) {
      if (!bubbleTutorialControl.active || !url) {
        return url;
      }

      const components = decomposeUrl(url);
      const params = components.query
        ? components.query.split('&').filter(Boolean)
        : [];

      const hasFlag = params.some(param => {
        const [key] = param.split('=');
        return key && key.toLowerCase() === 'bubbletutorial';
      });

      if (!hasFlag) {
        params.push('bubbletutorial=1');
      }

      components.query = params.join('&');
      return rebuildUrl(components);
    }

    function updateHistoryState(method, targetUrl) {
      const finalUrl = applyBubbleTutorialFlag(targetUrl);
      const stateData = { path: finalUrl };
      try {
        window.history[method](stateData, '', finalUrl);
      } catch (error) {
        debugWarn(`Unable to update history via ${method}:`, error);
      }
    }

    function removeBubbleTutorialFlagFromUrl() {
      try {
        const currentUrl = window.location.pathname + window.location.search + window.location.hash;
        const components = decomposeUrl(currentUrl);
        const params = components.query
          ? components.query.split('&').filter(Boolean)
          : [];
        const filtered = params.filter(param => {
          const [key] = param.split('=');
          return key && key.toLowerCase() !== 'bubbletutorial';
        });
        components.query = filtered.join('&');
        const cleanUrl = rebuildUrl(components);
        window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
      } catch (error) {
        debugWarn('Unable to remove bubbletutorial flag from URL:', error);
      }
    }

    function attemptBubbleTutorialAutoOpen() {
      if (!bubbleTutorialControl.requested || bubbleTutorialControl.openRequestSent) {
        return;
      }

      const iframe = iframeElements.bubble;
      if (!iframe || !iframe.contentWindow) {
        return;
      }

      try {
        iframe.contentWindow.postMessage({
          type: 'openBubbleTutorial',
          reason: 'url-param'
        }, '*');
        bubbleTutorialControl.openRequestSent = true;
      } catch (error) {
        debugWarn('Unable to request bubble tutorial overlay:', error);
      }
    }

    let cachedParentFooterHeight = 0;
    let cachedViewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;

    function getParentFooterHeight() {
      const footerEl = document.getElementById('mainFooter');
      if (!footerEl) {
        cachedParentFooterHeight = 0;
        return 0;
      }
      const rect = footerEl.getBoundingClientRect();
      cachedParentFooterHeight = Math.round(rect.height || 0);
      return cachedParentFooterHeight;
    }

    function broadcastViewportMetrics(targetKeys) {
      const keys = Array.isArray(targetKeys)
        ? targetKeys
        : (targetKeys ? [targetKeys] : ['bubble', 'line']);

      const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;
      if (viewportHeight) {
        cachedViewportHeight = viewportHeight;
      }

      keys.forEach(key => {
        const iframe = iframeElements[key];
        if (!iframe || !iframe.contentWindow) {
          return;
        }
        iframe.contentWindow.postMessage({
          type: 'parentViewportMetrics',
          viewportHeight: cachedViewportHeight,
          footerHeight: cachedParentFooterHeight
        }, '*');
      });
    }

    window.addEventListener('resize', () => {
      getParentFooterHeight();
      broadcastViewportMetrics();
    });
    window.addEventListener('resize', () => {
      getParentFooterHeight();
      const iframe = iframeElements.bubble;
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({
          type: 'parentFooterHeight',
          value: cachedParentFooterHeight
        }, '*');
      }
    });

    window.addEventListener('load', () => {
      getParentFooterHeight();
      broadcastViewportMetrics();
    });

    if (debugLoggingEnabled) {
      Object.values(iframeElements).forEach(iframe => {
        if (!iframe) return;

        try {
          const iframeUrl = new URL(iframe.getAttribute('src'), window.location.href);
          if (!iframeUrl.searchParams.has('debug')) {
            iframeUrl.searchParams.set('debug', '1');
            iframe.src = iframeUrl.toString();
          }
        } catch (error) {
          debugWarn('Unable to append debug flag to iframe source', error);
        }
      });
    }

    function areAllChartsReady() {
      return Object.values(chartReadyState).every(Boolean);
    }

    function resolveChartFromPath() {
      try {
        const segments = (window.location.pathname || '').split('/').filter(Boolean);
        if (segments.length === 0) {
          return null;
        }

        let lastSegment = segments[segments.length - 1].toLowerCase();
        lastSegment = lastSegment.replace(/\.html?$/, '');

        if (STATIC_CHART_IDS.has(lastSegment)) {
          return lastSegment;
        }

        if (lastSegment === 'index' && segments.length > 1) {
          const parentSegment = segments[segments.length - 2].toLowerCase().replace(/\.html?$/, '');
          if (STATIC_CHART_IDS.has(parentSegment)) {
            return parentSegment;
          }
        }

        return null;
      } catch (error) {
        debugWarn('Unable to resolve chart from path:', error);
        return null;
      }
    }

    function getBasePath() {
      const pathname = window.location.pathname || '/';
      const segments = pathname.split('/').filter(Boolean);

      if (segments.length === 0) {
        return '/';
      }

      const workingSegments = [...segments];

      const popIf = (predicate) => {
        if (!workingSegments.length) {
          return;
        }
        const candidate = workingSegments[workingSegments.length - 1].toLowerCase();
        if (predicate(candidate)) {
          workingSegments.pop();
          popIf(predicate);
        }
      };

      popIf(segment => /\.[^/.]+$/.test(segment));
      popIf(segment => STATIC_CHART_IDS.has(segment));

      if (!workingSegments.length) {
        return '/';
      }

      return '/' + workingSegments.join('/') + '/';
    }

    function getChartParam() {
      const pathChart = resolveChartFromPath();
      if (pathChart) {
        return pathChart;
      }
      const params = new URLSearchParams(window.location.search);
      return normalizeChartId(params.get('chart'));
    }

    function hasRequiredParams() {
      const params = new URLSearchParams(window.location.search);
      return params.has('pollutant_id');
    }

    function normalizeChartId(rawId) {
      if (!rawId) {
        return rawId;
      }

      const mapping = {
        '3': 'group-info',
        '4': 'user-guide',
        '5': 'resources',
        'group-info': 'group-info',
        'user-guide': 'user-guide',
        'resources': 'resources'
      };

      return mapping[rawId] || rawId;
    }

    function getDefaultUrl(chartId) {
      const basePath = getBasePath();
      const queryBase = basePath;

      const normalizedId = normalizeChartId(chartId) || '1';

      if (normalizedId === '1') {
        return `${queryBase}?chart=1&pollutant_id=5&group_ids=20,37&year=2023`;
      }
      if (normalizedId === '2') {
        return `${queryBase}?chart=2&pollutant_id=5&group_ids=1&start_year=1970&end_year=2023`;
      }
      if (STATIC_CHART_IDS.has(normalizedId)) {
        return `${basePath}${normalizedId}`;
      }

      return queryBase;
    }

    function selectChart(chartId) {
      // Show loading indicator if present
      const loadingEl = document.getElementById('loading');
      if (loadingEl) {
        loadingEl.classList.remove('hidden');
      }

      // Set default URL and load chart interface
      const defaultUrl = getDefaultUrl(chartId);
      updateHistoryState('replaceState', defaultUrl);

      setTimeout(async () => {
        await loadChartInterface(chartId);
      }, 500);
    }

    async function loadChartInterface(chartId) {
      try {
        console.log('Loading chart interface for chart', chartId);
        
        // Preload shared data 
        console.log('Preloading shared data...');
        await window.SharedDataLoader.loadSharedData();
        console.log('Shared data loaded successfully');
        
        // Simple delay to let everything initialize
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Reveal the interface
        await fadeToCompleteInterface(chartId);
        
        console.log('Chart interface loaded successfully');
      } catch (error) {
        console.error('Error loading chart interface:', error);
        
        // Fallback: show interface anyway
        const loadingEl = document.getElementById('loading');
        if (loadingEl) {
          loadingEl.classList.add('hidden');
        }

        const whiteOverlayEl = document.getElementById('white-overlay');
        if (whiteOverlayEl) {
          whiteOverlayEl.style.display = 'none';
        }

        document.getElementById('chart-interface').classList.remove('hidden');
        currentChart = normalizeChartId(chartId) || '1';
        updateTabStates();
        showChart(currentChart);
      }
    }

    async function fadeToCompleteInterface(chartId) {
      console.log('Starting fade to complete interface');
      
      // Set the active chart
      currentChart = normalizeChartId(chartId) || '1';
      
      // Ensure chart containers are ready
      const chartContainers = Array.from(document.querySelectorAll('.chart-container'));
      
      chartContainers.forEach(container => {
        container.style.display = 'block';
      });
      
      // Short delay to ensure positioning (v2.3 style)
      await new Promise(resolve => setTimeout(resolve, 250));
      
      // Start fade out of loading overlay and white overlay together
      const loading = document.getElementById('loading');
      const whiteOverlay = document.getElementById('white-overlay');

      if (loading) {
        loading.style.opacity = '0';
      }

      if (whiteOverlay) {
        whiteOverlay.style.opacity = '0';
      }
      
      // Reveal interface and charts simultaneously 
      requestAnimationFrame(() => {
        document.getElementById('chart-interface').classList.remove('hidden');
        updateTabStates();
        showChart(currentChart);
        
        // Mark charts as ready
        chartContainers.forEach(container => container.classList.add('ready'));
      });
      
      // Clean up after transition completes (v2.3 timing)
      setTimeout(() => {
        if (loading) {
          loading.classList.add('hidden');
        }

        if (whiteOverlay) {
          whiteOverlay.style.display = 'none';
        }
        console.log('Fade to complete interface finished');
      }, 400);
    }

    // Simplified chart loading - no complex coordination needed

    function hasParamsForChart(chartId, params) {
      if (!params) return false;
      if (chartId === '1') {
        return ['pollutant_id', 'group_ids', 'year'].every(key => params.has(key) && params.get(key));
      }
      if (chartId === '2') {
        return ['pollutant_id', 'group_ids', 'start_year', 'end_year'].every(key => params.has(key) && params.get(key));
      }
      return false;
    }

    function extractChartState(chartId, params) {
      if (!hasParamsForChart(chartId, params)) {
        return [];
      }
      if (chartId === '1') {
        return [
          `pollutant_id=${params.get('pollutant_id')}`,
          `group_ids=${params.get('group_ids')}`,
          `year=${params.get('year')}`
        ];
      }
      if (chartId === '2') {
        return [
          `pollutant_id=${params.get('pollutant_id')}`,
          `group_ids=${params.get('group_ids')}`,
          `start_year=${params.get('start_year')}`,
          `end_year=${params.get('end_year')}`
        ];
      }
      return [];
    }

    function switchChart(rawChartId) {
      const chartId = normalizeChartId(rawChartId) || '1';

      if (currentChart === chartId) return;

      const urlParams = new URLSearchParams(window.location.search);

      if ((!chartStates[chartId] || chartStates[chartId]?.length === 0) && hasParamsForChart(chartId, urlParams)) {
        chartStates[chartId] = extractChartState(chartId, urlParams);
      }

      const storedState = chartStates[chartId];
      const basePath = getBasePath();
      const queryBase = basePath;

      if (storedState && storedState.length > 0) {
        console.log('Using stored state for chart', chartId, storedState);
        const paramsArray = ['chart=' + chartId, ...storedState];
        const newQuery = paramsArray.join('&');
        const newUrl = `${queryBase}?${newQuery}`;
        const historyMethod = currentChart ? 'pushState' : 'replaceState';

        if (window.location.search.substring(1) !== newQuery || normalizeChartId(urlParams.get('chart')) !== chartId) {
          updateHistoryState(historyMethod, newUrl);
        }
      } else {
        console.log('No stored state for chart', chartId, '- using defaults');

        const historyMethod = currentChart ? 'pushState' : 'replaceState';
        let newUrl = null;

        if (chartId === '1' || chartId === '2') {
          const newParams = new URLSearchParams();
          newParams.set('chart', chartId);

          if (chartId === '1') {
            newParams.set('pollutant_id', '5');
            newParams.set('group_ids', '20,37');
            newParams.set('year', '2023');
            chartStates['1'] = ['pollutant_id=5', 'group_ids=20,37', 'year=2023'];
          } else if (chartId === '2') {
            newParams.set('pollutant_id', '5');
            newParams.set('group_ids', '1');
            newParams.set('start_year', '1970');
            newParams.set('end_year', '2023');
            chartStates['2'] = ['pollutant_id=5', 'group_ids=1', 'start_year=1970', 'end_year=2023'];
          }

          const paramsArray = [];
          for (const [key, value] of newParams) {
            if (key === 'group_ids' || key === 'start_year' || key === 'end_year' || key === 'year') {
              paramsArray.push(`${key}=${value}`);
            } else {
              paramsArray.push(`${key}=${encodeURIComponent(value)}`);
            }
          }

          const newQuery = paramsArray.join('&');
          newUrl = `${queryBase}?${newQuery}`;
        } else if (STATIC_CHART_IDS.has(chartId)) {
          newUrl = `${basePath}${chartId}`;
          chartStates[chartId] = [];
        }

        if (newUrl) {
          updateHistoryState(historyMethod, newUrl);
        }
      }

      currentChart = chartId;
      updateTabStates();
      showChart(chartId);

    }

    function updateTabStates() {
      // Update tab appearance
      const baseClasses = 'py-4 px-2 border-b-2 font-semibold text-[21px] transition-colors flex items-center gap-2';
      const activeClasses = `${baseClasses} tab-active`;
      const inactiveClasses = `${baseClasses} border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300`;

      document.querySelectorAll('[id^="tab-"]').forEach(tab => {
        const tabChart = normalizeChartId(tab.dataset.chart);
        if (!tabChart) {
          return;
        }
        const isActive = tabChart === currentChart;
        tab.className = isActive ? activeClasses : inactiveClasses;
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
        tab.tabIndex = isActive ? 0 : -1;
      });
    }

    function focusTab(chartId) {
      const normalizedId = normalizeChartId(chartId) || '1';
      const tabId = TAB_ID_MAP[normalizedId];
      if (!tabId) {
        return;
      }
      const tabElement = document.getElementById(tabId);
      if (!tabElement) {
        return;
      }

      try {
        tabElement.focus({ preventScroll: true });
      } catch (error) {
        tabElement.focus();
      }
    }

    function showChart(chartId) {
      // Use visibility to allow both charts to render, but only show one
      document.querySelectorAll('.chart-container').forEach(container => {
        container.style.visibility = 'hidden';
        container.style.height = '0';
        container.style.overflow = 'hidden';
        container.setAttribute('aria-hidden', 'true');
      });
      
      const normalizedId = normalizeChartId(chartId) || '1';
      const chartContainer = document.getElementById(`chart-${normalizedId}`);
      if (!chartContainer) {
        debugWarn('Unable to locate chart container for', normalizedId);
        return;
      }
      chartContainer.style.visibility = 'visible';
      chartContainer.style.height = 'auto';
      chartContainer.style.overflow = 'visible';
      chartContainer.setAttribute('aria-hidden', 'false');

    }

    function handleTabKeyboardNavigation(event) {
      if (event.defaultPrevented) {
        return;
      }

      if (event.metaKey || event.ctrlKey || event.altKey) {
        return;
      }

      if (event.key !== 'ArrowLeft' && event.key !== 'ArrowRight') {
        return;
      }

      const activeElement = document.activeElement;
      if (activeElement && (activeElement.isContentEditable || ['input', 'textarea', 'select'].includes(activeElement.tagName.toLowerCase()))) {
        return;
      }

      if (!currentChart) {
        return;
      }

      event.preventDefault();

      const normalizedCurrent = normalizeChartId(currentChart) || '1';
      const currentIndex = CHART_SEQUENCE.indexOf(normalizedCurrent);
      if (currentIndex === -1) {
        return;
      }

      const delta = event.key === 'ArrowRight' ? 1 : -1;
      const nextIndex = (currentIndex + delta + CHART_SEQUENCE.length) % CHART_SEQUENCE.length;
      const nextChartId = CHART_SEQUENCE[nextIndex];

      if (nextChartId === normalizedCurrent) {
        return;
      }

      const preservedScrollX = window.scrollX;
      const preservedScrollY = window.scrollY;

      switchChart(nextChartId);

      requestAnimationFrame(() => {
        window.scrollTo({ top: preservedScrollY, left: preservedScrollX });
        focusTab(nextChartId);
      });
    }


    // Simplified initialization for iframe-based charts
    
    // Simple loading overlay control - MESSAGE BASED APPROACH
    let overlayHidden = false;
    const heightsReceived = { bubble: false, line: false };
    
    // Set initial reasonable height estimate
    const lineIframe = iframeElements.line;
    if (lineIframe) {
      lineIframe.style.height = '1200px'; // Initial estimate
      console.log('üìè Line chart iframe initial height: 1200px');
    }

    const bubbleIframe = iframeElements.bubble;
    if (bubbleIframe) {
      bubbleIframe.style.height = '1100px';
      console.log('üìè Bubble chart iframe initial height: 1100px');
    }

    const groupInfoIframe = iframeElements['group-info'];
    if (groupInfoIframe) {
      groupInfoIframe.style.height = '1000px';
      console.log('üìè Group info iframe initial height: 1000px');
    }

    const userGuideIframe = iframeElements['user-guide'];
    if (userGuideIframe) {
      userGuideIframe.style.height = '1000px';
      console.log('üìè User guide iframe initial height: 1000px');
    }

    const resourcesIframe = iframeElements.resources;
    if (resourcesIframe) {
      resourcesIframe.style.height = '800px';
      console.log('üìè Resources iframe initial height: 800px');
    }
    
    // Set up message listener IMMEDIATELY (before DOM is ready)
    console.log('üéØ Setting up message listener...');
    window.addEventListener('message', function(event) {
      console.log('üî• Parent received message:', event.data);

      if (event.data && event.data.type === 'scrollToBubbleTutorial') {
        const requestId = event.data.requestId;
        const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const bubbleContainer = document.getElementById('chart-1') || document.getElementById('bubblechart-iframe');
        const headerOffset = 32;
        const scrollTarget = bubbleContainer;

        let scrolled = false;
        if (scrollTarget) {
          const rect = scrollTarget.getBoundingClientRect();
          const pageOffset = window.pageYOffset || document.documentElement.scrollTop || 0;
          const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;
          const containerHeight = rect.height || scrollTarget.offsetHeight || 0;
          const centerOffset = Math.max(0, (viewportHeight - containerHeight) / 2);
          const targetTop = Math.max(0, rect.top + pageOffset - centerOffset - headerOffset);
          const currentTop = window.pageYOffset || document.documentElement.scrollTop || 0;
          if (Math.abs(currentTop - targetTop) > 4) {
            window.scrollTo({ top: targetTop, behavior: prefersReducedMotion ? 'auto' : 'smooth' });
            scrolled = true;
          }
        }

        const acknowledge = () => {
          try {
            if (event.source && typeof event.source.postMessage === 'function') {
              event.source.postMessage({ type: 'bubbleTutorialScrollComplete', requestId }, '*');
            }
          } catch (error) {
            console.warn('Unable to acknowledge bubble tutorial scroll:', error);
          }
        };

        if (prefersReducedMotion || !scrolled) {
          acknowledge();
        } else {
          setTimeout(acknowledge, 200);
        }
        return;
      }

      // Handle URL updates from iframes
      if (event.data && event.data.type === 'updateUrl') {
        console.log('üîó Updating URL to:', event.data.url);
        updateHistoryState('replaceState', event.data.url);
      }

      if (event.data && event.data.type === 'bubbleTutorialState') {
        if (event.data.state === 'opened') {
          bubbleTutorialControl.openRequestSent = true;

          if (!bubbleTutorialControl.active) {
            bubbleTutorialControl.active = true;
            bubbleTutorialControl.requested = false;
            const currentUrl = window.location.pathname + window.location.search + window.location.hash;
            updateHistoryState('replaceState', currentUrl);
          }
        } else if (event.data.state === 'closed' && bubbleTutorialControl.active) {
          bubbleTutorialControl.active = false;
          bubbleTutorialControl.requested = false;
          bubbleTutorialControl.openRequestSent = false;
          removeBubbleTutorialFlagFromUrl();
        }
        return;
      }
      
      if (event.data && event.data.type === 'chartReady' && !overlayHidden) {
        const chartKey = event.data.chart;
        const keyLabel = typeof chartKey === 'string'
          ? chartKey.charAt(0).toUpperCase() + chartKey.slice(1)
          : 'Unknown';

        console.log('üì® Chart ready message received');
        console.log('üéØ Chart type:', chartKey);
        
        if (chartReadyState.hasOwnProperty(chartKey)) {
          chartReadyState[chartKey] = true;
          console.log(`‚úÖ ${keyLabel} chart is ready`);
        } else {
          debugWarn('‚ö†Ô∏è Unknown chart reported ready:', chartKey);
        }

        if (chartKey === 'bubble') {
          attemptBubbleTutorialAutoOpen();
        }
        
        if (areAllChartsReady()) {
          console.log('‚úÖ All charts ready - requesting heights before hiding overlay');
          Object.entries(iframeElements).forEach(([key, iframe]) => {
            if (iframe && iframe.contentWindow) {
              console.log(`üìê Requesting height from ${key} chart iframe...`);
              iframe.contentWindow.postMessage({ type: 'requestHeight' }, '*');
            }
          });
        } else {
          const pending = Object.entries(chartReadyState)
            .filter(([, ready]) => !ready)
            .map(([key]) => key)
            .join(', ');
          console.log(`‚è≥ Waiting for: ${pending}`);
        }
      }
      
      // Handle content height from iframe (sent once after initial render)
      if (event.data && event.data.type === 'contentHeight') {
        const chartKey = event.data.chart;
        const iframe = iframeElements[chartKey];
        
        if (iframe) {
          const reportedHeight = Number(event.data.height);
          const fallbackHeight = 900;
          const safeHeight = Number.isFinite(reportedHeight) && reportedHeight > 0
            ? reportedHeight
            : fallbackHeight;

          let finalHeight = safeHeight;

          if (chartKey === 'group-info') {
            const container = document.getElementById('chart-group-info');
            const containerVisible = container && container.getAttribute('aria-hidden') === 'false';
            if (containerVisible) {
              const iframeRect = iframe.getBoundingClientRect();
              const footerEl = document.querySelector('#chart-interface > footer');
              const footerRect = footerEl ? footerEl.getBoundingClientRect() : null;
              const footerStyles = footerEl ? window.getComputedStyle(footerEl) : null;
              const footerMargins = footerStyles
                ? (parseFloat(footerStyles.marginTop) || 0) + (parseFloat(footerStyles.marginBottom) || 0)
                : 0;
              const reservedFooterSpace = (footerRect?.height || 0) + footerMargins;
              const viewportRemaining = Math.max(window.innerHeight - Math.max(iframeRect.top, 0) - reservedFooterSpace, 0);
              finalHeight = Math.max(safeHeight, viewportRemaining, 320);
            }
          }

          if (!Number.isFinite(reportedHeight) || reportedHeight <= 0) {
            debugWarn(`‚ö†Ô∏è Received invalid height (${event.data.height}) from ${chartKey}; using fallback ${safeHeight}px`);
          } else {
            console.log(`üìè Received content height from ${chartKey}: ${reportedHeight}px`);
          }

          iframe.style.height = finalHeight + 'px';
          if (chartKey === 'bubble' || chartKey === 'line') {
            getParentFooterHeight();
            broadcastViewportMetrics(chartKey);
          }
          
          heightsReceived[chartKey] = true;
          
          if (heightsReceived.bubble && heightsReceived.line && areAllChartsReady()) {
            console.log('‚úÖ Both chart heights received, layout stable - hiding overlay now');
            setTimeout(() => {
              window.hideLoadingOverlay();
            }, 50);
          }
        }
      }
      
      // Debug messages from iframes
      if (event.data && event.data.type === 'debug') {
        console.log('üêõ Debug message from iframe:', event.data.message);
      }
      
      // URL update messages from iframe
      if (event.data && event.data.type === 'updateURL') {
        const iframeEntry = Object.entries(iframeElements).find(([, iframe]) => iframe && iframe.contentWindow === event.source);
        let chartKey = null;

        if (iframeEntry) {
          const sourceKey = iframeEntry[0];
          if (sourceKey === 'bubble') {
            chartKey = '1';
          } else if (sourceKey === 'line') {
            chartKey = '2';
          } else {
            chartKey = normalizeChartId(sourceKey) || null;
          }
        }

        if (!chartKey) {
          const fallbackParam = normalizeChartId(new URLSearchParams(window.location.search).get('chart'));
          chartKey = fallbackParam || currentChart || '1';
        }

        const paramsArray = Array.isArray(event.data.params) ? event.data.params : [];
        chartStates[chartKey] = paramsArray;

        if (currentChart !== chartKey) {
          console.log(`‚ÑπÔ∏è Stored state for inactive chart ${chartKey}; URL unchanged`);
          return;
        }

        const basePath = getBasePath();
        const newParams = ['chart=' + chartKey, ...paramsArray];
        const newUrl = `${basePath}?${newParams.join('&')}`;

        updateHistoryState('replaceState', newUrl);
        console.log('üîó URL updated:', newUrl);
      }
      
      // Line debug messages
      if (event.data && event.data.type === 'lineDebug') {
        console.log('üêõ Line chart debug:', event.data.payload);
      }
    });
    
    // Hide loading overlay function - make it global for iframe onload
    window.hideLoadingOverlay = function() {
      if (overlayHidden) {
        return;
      }
      overlayHidden = true;
      
      const overlay = document.getElementById('main-loading-overlay');
      const chartInterface = document.getElementById('chart-interface');
      
      if (chartInterface) {
        // Make chart interface visible instantly (no transition)
        // The overlay fade will handle the visual reveal
        chartInterface.style.opacity = '1';
      }
      
      if (overlay) {
        overlay.style.opacity = '0';
        
        setTimeout(() => {
          if (overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
          
          // Notify iframes that overlay is fully hidden and they can respond to resizes
          Object.values(iframeElements).forEach(iframe => {
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage({ type: 'overlayHidden' }, '*');
            }
          });
          
        }, 500);
      }
    };
    
    // Initialize when DOM ready
    window.addEventListener('DOMContentLoaded', function() {
      console.log('Main page DOM loaded');
      const pathChart = resolveChartFromPath();
      const urlParams = new URLSearchParams(window.location.search);
      let chartParam = pathChart || urlParams.get('chart') || '1';

      if (bubbleTutorialControl.requested) {
        chartParam = '1';
      }

      chartParam = normalizeChartId(chartParam) || '1';
      console.log('Initial chart selection:', chartParam);
      switchChart(chartParam);

      document.addEventListener('keydown', handleTabKeyboardNavigation);
      
    // Comprehensive iframe debugging
    const lineIframe = iframeElements.line;
    const bubbleIframe = iframeElements.bubble;
      
      if (lineIframe) {
        if (debugLoggingEnabled) {
          console.log('Line chart iframe found, src:', lineIframe.src);

          lineIframe.addEventListener('load', () => {
            console.log('Line chart iframe loaded event fired');
            console.log('‚è∞ Waiting for chartReady message from iframe...');

            // Debug iframe script execution
            setTimeout(() => {
              console.log('üîç Checking if iframe scripts loaded...');
              try {
                const iframeDoc = lineIframe.contentDocument || lineIframe.contentWindow.document;
                console.log('üîç Iframe document readyState:', iframeDoc.readyState);
                console.log('üîç Iframe body exists:', !!iframeDoc.body);

                // Check if scripts are present
                const scripts = iframeDoc.querySelectorAll('script');
                console.log('üîç Number of scripts found in iframe:', scripts.length);

                if (scripts.length === 0) {
                  console.log('‚ö†Ô∏è NO SCRIPTS IN IFRAME - This is abnormal!');
                  console.log('üîç Checking iframe HTML source...');
                  console.log('üîç First 500 chars of iframe HTML:', iframeDoc.documentElement.innerHTML.substring(0, 500));

                  // The iframe HTML is not loading scripts - possible iframe security issue
                  // Let's force a reload
                  console.log('üîÑ Attempting iframe reload...');
                  lineIframe.src = lineIframe.src; // Force reload
                } else {
                  // List script details
                  scripts.forEach((script, index) => {
                    console.log(`üîç Script ${index + 1}:`, {
                      src: script.src || 'inline',
                      hasContent: !!script.textContent.trim(),
                      type: script.type || 'text/javascript'
                    });
                  });
                }

              } catch (e) {
                console.log('üîç Cannot access iframe document (security restrictions):', e.message);
              }
            }, 1000);
          });
        }

        lineIframe.addEventListener('error', (e) => {
          console.error('Line chart iframe error:', e);
          // Hide overlay even on error
          setTimeout(() => {
            console.log('Error: Hiding overlay due to iframe error');
            hideLoadingOverlay();
          }, 2000);
        });
      }
      
      if (bubbleIframe && debugLoggingEnabled) {
        console.log('Bubble chart iframe found, src:', bubbleIframe.src);
        bubbleIframe.addEventListener('load', () => {
          console.log('Bubble chart iframe loaded');
        });
      }
    });
  </script>
</body>
</html>