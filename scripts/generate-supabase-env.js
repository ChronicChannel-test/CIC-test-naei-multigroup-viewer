#!/usr/bin/env node
/**
 * Generates SharedResources/supabase-env.js from environment variables.
 *
 * Usage:
 *   npm run supabase:env              # uses .env.local -> .env fallback
 *   SUPABASE_ENV_FILE=.env.prod npm run supabase:env
 */

const fs = require('fs');
const path = require('path');
const dotenv = require('dotenv');

const projectRoot = path.resolve(__dirname, '..');
const sharedResourcesDir = path.join(projectRoot, 'SharedResources');
const outputPath = path.join(sharedResourcesDir, 'supabase-env.js');

const candidates = [
  process.env.SUPABASE_ENV_FILE,
  path.join(projectRoot, '.env.local'),
  path.join(projectRoot, '.env')
].filter(Boolean);

let loadedEnvPath = null;
for (const candidate of candidates) {
  if (!candidate) continue;
  if (!fs.existsSync(candidate)) {
    continue;
  }
  dotenv.config({ path: candidate, override: true });
  loadedEnvPath = candidate;
  break;
}

if (!loadedEnvPath) {
  dotenv.config({ override: true });
}

const url = process.env.NAEI_SUPABASE_URL || process.env.SUPABASE_URL;
const key = process.env.NAEI_SUPABASE_KEY
  || process.env.NAEI_SUPABASE_PUBLISHABLE_KEY
  || process.env.SUPABASE_PUBLISHABLE_KEY
  || process.env.SUPABASE_ANON_KEY
  || process.env.SUPABASE_KEY;
const storageKeyBase = process.env.NAEI_SUPABASE_STORAGE_KEY_BASE
  || process.env.SUPABASE_STORAGE_KEY_BASE
  || deriveStorageKeyBase(url);

if (!url || !key) {
  console.error('[generate-supabase-env] Missing SUPABASE_URL or SUPABASE_PUBLISHABLE_KEY (legacy SUPABASE_ANON_KEY) in environment.');
  process.exit(1);
}

const banner = `// Auto-generated by scripts/generate-supabase-env.js on ${new Date().toISOString()}
// Source env file: ${loadedEnvPath || 'process environment'}
`;

const fileBody = `${banner}
window.__NAEI_SUPABASE_CONFIG = Object.freeze({
  url: ${JSON.stringify(url)},
  key: ${JSON.stringify(key)},
  storageKeyBase: ${JSON.stringify(storageKeyBase)}
});
`;

fs.mkdirSync(sharedResourcesDir, { recursive: true });
fs.writeFileSync(outputPath, fileBody);
console.log(`[generate-supabase-env] Wrote ${path.relative(projectRoot, outputPath)} using ${loadedEnvPath || 'process env'}`);

function deriveStorageKeyBase(supabaseUrl) {
  if (!supabaseUrl) {
    return 'sb-naei-auth-token';
  }
  try {
    const ref = new URL(supabaseUrl).hostname.split('.')[0];
    return `sb-${ref}-auth-token`;
  } catch (error) {
    return 'sb-naei-auth-token';
  }
}
